<script type="text/javascript" th:src="@{/fs/js/jquery.js}"></script>
<div class="sub-cont w-100">
  <div class="row store-log">
    <input id="prm_areacode" type="hidden" th:value="${prm_areacode}"/>
    <input id="prm_strcode" type="hidden" th:value="${prm_strcode}"/>
    <input id="prm_snsrid" type="hidden" th:value="${prm_snsrid}"/>
    <div class="col-3">
      <table class="store-datalog-meta">
        <tr class="monkwh"><th>이번달<br/>사용전력량</th><td><span></span>kWh</td></tr>
        <tr class="kw"><th>전력</th><td><span></span>kW</td></tr>
        <tr class="vo"><th>전압</th><td><span></span>V</td></tr>
        <tr class="am"><th>전류</th><td><span></span>A</td></tr>
        <tr class="hz"><th>주파수</th><td><span></span>Hz</td></tr>
        <tr class="per"><th>역률</th><td><span></span>%</td></tr>
        <tr class="igo"><th>누설전류(IGO)</th><td><span></span>mA</td></tr>
        <tr class="igr"><th>누설전류(IGR)</th><td><span></span>mA</td></tr>
        <tr class="igc"><th>누설전류(IGC)</th><td><span></span>mA</td></tr>
        <tr class="meg"><th>절연저항</th><td><span></span>MΩ</td></tr>
        <tr class="kwh"><th>누적전력량</th><td><span></span>kWh</td></tr>
        <tr class="dbm"><th>수신감도(RSSI)</th><td><span></span>dBm</td></tr>
        <tr class="ppm"><th>Co센서#1</th><td><span></span>ppm</td></tr>
        <tr class="gid"><th>G/W ID</th><td><span></span></td></tr>
      </table>
    </div>
    <div class="col-9">
      <div class="row p-2">
        <div class="col-12 align-middle">
          <div class="form-group custom-control custom-checkbox custom-control-inline">
            <input type="checkbox" class="custom-control-input" id="check-total">
            <label class="custom-control-label" for="check-total">전체</label>
          </div>
          <div class="form-group custom-control custom-checkbox custom-control-inline">
            <input type="checkbox" class="custom-control-input" id="check-danger" checked="checked">
            <label class="custom-control-label" for="check-danger">경고</label>
          </div>
          <div class="form-group custom-control custom-checkbox custom-control-inline">
            <input type="checkbox" class="custom-control-input" id="check-warn">
            <label class="custom-control-label" for="check-warn">주의</label>
          </div>
          <div class="form-group custom-control-inline">
            <input class="form-control" id="regdt" type="date"/>
          </div>
          <button type="button" class="btn btn-sm btn-success waves-effect waves-themed" onclick="fn_getDataLogFiltered();">조회</button>
        </div>
      </div>
      <div class="store-datalog-filtered-list alert alert-info bg-white m-2"></div>
    </div>
  </div>
  <script type="text/javascript">
    $(function(){
      fn_initStoreDataLog();
    });

    function fn_initStoreDataLog() {
      $.template('datalog', '<p class="{{html STATE}}" data-index="{{html INDEX}}" data-regdt="{{html REGDATE}}" data-almtype="{{html ALMTYPE}}">[{{html SNSRRCVTIME}}] {{html SNSRID}} : {{html DATALOG}}</p>');
      $('.store-log #check-total').on('click', fn_checkDataLogFiltered);
      $('.store-log #check-danger').on('click', fn_checkDataLogFiltered);
      $('.store-log #check-warn').on('click', fn_checkDataLogFiltered);
      $('.store-log #regdt').on('change', fn_getDataLogFiltered);
      $('.store-datalog-filtered-list').on('click', 'p', function(){
        fn_setDataLogMeta($(this).attr('data-index'));
      });
      $('.store-log #regdt').val(fn_dateToString(new Date()).slice(0, 10));
      fn_getDataLogFiltered();
    }

    function fn_checkDataLogFiltered() {
      if ($(this).attr('id') == 'check-total') {
        $('.store-log #check-danger').prop('checked', false);
        $('.store-log #check-warn').prop('checked', false);
      }
      if ($('.store-log #check-danger:checked').length + $('.store-log #check-warn:checked').length == 0)
        $('.store-log #check-total').prop('checked', true);
      else $('.store-log #check-total').prop('checked', false);
      fn_showDataLogFiltered();
    }

    function fn_showDataLogFiltered() {
      if($('.store-log #check-total:checked').length>0) $('.store-datalog-filtered-list p').show();
      else $('.store-datalog-filtered-list p').hide();
      if($('.store-log #check-danger:checked').length>0) $('.store-datalog-filtered-list p.DANGER').show();
      if($('.store-log #check-warn:checked').length>0) $('.store-datalog-filtered-list p.WARN').show();
    }

    function fn_getDataLogFiltered() {
      $.post($('#contextRoot').val()+'/mng/dataLogListAjax', {
        strcode: $('.store-log #prm_strcode').val(),
        regdt: $('.store-log #regdt').val()
      }, function (d) {
        window.datalog = d;
        $('.store-datalog-filtered-list').html('');
        for(var i=0; i<d.length; i++) {
          d[i].INDEX = i;
          d[i].DATALOG = '전력: '+d[i].SNSRWATT+'kW | 전류: '+d[i].SNSRAMPERE+'mA | 누설전류: '+d[i].SNSRIGO+'mA';
          if(d[i].STATE) d[i].DATALOG = d[i].LCAUSE;
          $('.store-datalog-filtered-list').append($.tmpl('datalog',d[i]));
        }
        fn_setDataLogMeta(0);
        fn_showDataLogFiltered();
      });
    }

    function fn_setDataLogMeta(i) {
      $('.store-datalog-meta .monkwh td span').text();
      $('.store-datalog-meta .kw td span').text(window.datalog[i].SNSRWATT.toFixed(3));
      $('.store-datalog-meta .vo td span').text(window.datalog[i].SNSRVOLT.toFixed(3));
      $('.store-datalog-meta .am td span').text(window.datalog[i].SNSRAMPERE.toFixed(3));
      $('.store-datalog-meta .hz td span').text(window.datalog[i].SNSRHZ.toFixed(3));
      $('.store-datalog-meta .per td span').text(window.datalog[i].SNSRPF.toFixed(3));
      $('.store-datalog-meta .igo td span').text(window.datalog[i].SNSRIGO.toFixed(3));
      $('.store-datalog-meta .igr td span').text(window.datalog[i].SNSRIGR.toFixed(3));
      $('.store-datalog-meta .igc td span').text(window.datalog[i].SNSRIGC.toFixed(3));
      $('.store-datalog-meta .meg td span').text(window.datalog[i].SNSRREG.toFixed(3));
      $('.store-datalog-meta .kwh td span').text(window.datalog[i].SNSRKWH.toFixed(3));
      $('.store-datalog-meta .dbm td span').text(window.datalog[i].SNSRRSSI.toFixed(3));
      $('.store-datalog-meta .ppm td span').text(window.datalog[i].SNSRRSSI.toFixed(3));
      $('.store-datalog-meta .gid td span').text();
    }
  </script>
</div>