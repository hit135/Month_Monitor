<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.fscom.firsens.district.repository.DistrictRepo">

    <select id="SELECT_YESTERDAY_EVENT_COMP_STAT" parameterType="map" resultType="map">
        SELECT I.SNSRCNT - A.ERRCNT AS YSNSRCNT
             , A.DANGERCNT AS YDANGERCNT
             , A.WARNINGCNT AS YWARNINGCNT
             , I.SNSRCNT - B.ERRCNT AS TSNSRCNT
             , B.DANGERCNT AS TDANGERCNT
             , B.WARNINGCNT AS TWARNINGCNT
        FROM ( SELECT COUNT(DISTINCT CASE WHEN (OCALM + IGOALM + IGRALM) > 0 THEN SNSRSEQ END) AS ERRCNT
                    , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN SNSRSEQ END) AS DANGERCNT
                    , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN SNSRSEQ END) AS WARNINGCNT
               FROM V_ALL_SENSOR_LOG_MAP
               WHERE REGDATE BETWEEN CONCAT(DATE(NOW() - INTERVAL 1 DAY), ' 00:00:00') AND CONCAT(DATE(NOW() - INTERVAL 1 DAY), ' 23:59:59')
        ) A
           , ( SELECT COUNT(DISTINCT CASE WHEN (OCALM + IGOALM + IGRALM) > 0 THEN SNSRSEQ END) AS ERRCNT
                    , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN SNSRSEQ END) AS DANGERCNT
                    , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN SNSRSEQ END) AS WARNINGCNT
               FROM V_ALL_SENSOR_LOG_MAP
               WHERE REGDATE BETWEEN CONCAT(DATE(NOW()), ' 00:00:00') AND NOW()
        ) B
           , ( SELECT COUNT(*) AS SNSRCNT FROM F_SENSOR_INFO WHERE DELYN = 'N' ) I
    </select>

    <select id="SELECT_TODAY_EVENT_STAT" parameterType="map" resultType="map">
        SELECT S.STRCNT
             , I.SNSRCNT
             , L.DANGERCNT
             , L.WARNINGCNT
             , L.DISCONNCNT
        FROM ( SELECT COUNT(*) AS STRCNT FROM F_STORE WHERE USEYN = 'Y' AND DELYN = 'N' ) S
           , ( SELECT COUNT(*) AS SNSRCNT FROM F_SENSOR_INFO WHERE DELYN = 'N' ) I
           , ( SELECT COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN SNSRSEQ END) AS DANGERCNT
                    , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN SNSRSEQ END) AS WARNINGCNT
                    , COUNT(DISTINCT CASE WHEN DISCONN = 1 THEN SNSRSEQ END) AS DISCONNCNT
               FROM V_ALL_SENSOR_LOG_MAP
               WHERE REGDATE BETWEEN CONCAT(DATE(NOW()), ' 00:00:00') AND NOW() ) L
    </select>

    <select id="LIST_CURR_GU_MAP_EVENT_STAT" parameterType="map" resultType="map">
        <![CDATA[
        SELECT I.GUCODE
             , I.SNSRCNT
             , COALESCE(L.DANGERCNT, 0) AS DANGERCNT
             , COALESCE(L.WARNINGCNT, 0) AS WARNINGCNT
             , COALESCE(D.DISCONNCNT, 0) AS DISCONNCNT
        FROM ( SELECT GUCODE, COUNT(SNSRSEQ) AS SNSRCNT FROM V_ALL_SENSOR_MAP GROUP BY GUCODE ) I
                 LEFT JOIN ( SELECT GUCODE
                                  , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN SNSRSEQ END) AS DANGERCNT
                                  , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN SNSRSEQ END) AS WARNINGCNT
                             FROM V_ALL_SENSOR_LOG_MAP
                             WHERE REGDATE BETWEEN CONCAT(DATE(NOW()), ' 00:00:00') AND NOW()
                             GROUP BY GUCODE ) L
                           ON I.GUCODE = L.GUCODE
                 LEFT JOIN ( SELECT GUCODE
                                  , COUNT(DISTINCT SNSRSEQ) AS DISCONNCNT
                             FROM V_ALL_SENSOR_MAP
                             WHERE DATARCVTIME < NOW() - INTERVAL 30 MINUTE
                             GROUP BY GUCODE ) D
                           ON I.GUCODE = D.GUCODE
--          WHERE I.GUCODE != '30200'
        ]]>
    </select>

    <select id="LIST_MONTHLY_GU_EVENT_COMP_STAT" parameterType="map" resultType="map">
        SELECT L.GUCODE
             , COALESCE(A.EVENTCNT, 0) AS THATEVENTCNT
             , COALESCE(B.EVENTCNT, 0) AS THISEVENTCNT
        FROM ( SELECT DISTINCT GUCODE FROM F_GUCODE WHERE GRPCODE = '042' AND USEYN = 'Y' ) L
                 LEFT JOIN ( SELECT GUCODE, COALESCE(SUM(TOTOCALM) + SUM(TOTIGALM), 0) AS EVENTCNT
                             FROM F_CRN_AREA_ELEC_DAILY_STAT
                             WHERE DATE_FORMAT(SDATE, '%Y-%m') = DATE_FORMAT(NOW() - INTERVAL 1 MONTH, '%Y-%m')
                             GROUP BY GUCODE ) A
                           ON L.GUCODE = A.GUCODE
                 LEFT JOIN ( SELECT SS.GUCODE, COALESCE(SUM(SS.EVENTCNT), 0) AS EVENTCNT
                             FROM ( SELECT GUCODE, COALESCE(SUM(TOTOCALM) + SUM(TOTIGALM), 0) AS EVENTCNT
                                    FROM F_CRN_AREA_ELEC_DAILY_STAT
                                    WHERE DATE_FORMAT(SDATE, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
                                    GROUP BY GUCODE
                                    UNION ALL
                                    SELECT GUCODE
                                         , COUNT(DISTINCT CASE WHEN (OCALM + IGRALM + IGOALM) > 0 THEN LSEQ END) AS EVENTCNT
                                    FROM V_ALL_SENSOR_LOG_MAP
                                    WHERE ( REGDATE BETWEEN CONCAT(DATE(NOW()), ' 00:00:00') and NOW() )
                                    GROUP BY GUCODE ) SS
                             GROUP BY SS.GUCODE ) B
                           ON A.GUCODE = B.GUCODE
        WHERE L.GUCODE != '30200'
        ORDER BY L.GUCODE
    </select>

    <select id="LIST_TODAY_GU_AREA_EVENT_COMP_RANK" parameterType="map" resultType="map">
        SELECT DISTINCT L.GUCODE
                      , L.GUNAME
                      , L.AREACODE
                      , L.AREANAME
                      , COALESCE(R1.DANGERCNT, 0) AS THISDANGERCNT
                      , COALESCE(R1.WARNINGCNT, 0) AS THISWARNINGCNT
                      , RANK() OVER (ORDER BY (COALESCE(R1.DANGERCNT, 0) + COALESCE(R1.WARNINGCNT, 0)) DESC) AS 'RANK'
             , COALESCE(R2.DANGERCNT, 0) AS THATDANGERCNT
                      , COALESCE(R2.WARNINGCNT, 0) AS THATWARNINGCNT
        FROM ( SELECT A.GUCODE, B.GUNAME, A.AREACODE, A.AREANAME
               FROM F_LEVEL_AREA A
                        LEFT JOIN F_GUCODE B
                                  ON A.GUCODE = B.GUCODE
               WHERE A.AREALEVEL = 1 AND A.USEYN = 'Y' AND A.DELYN = 'N' ) L
                 LEFT JOIN ( SELECT AREACODE
                                  , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN LSEQ END) AS DANGERCNT
                                  , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN LSEQ END) AS WARNINGCNT
                             FROM V_ALL_SENSOR_LOG_MAP
                             WHERE REGDATE BETWEEN CONCAT(DATE(NOW()), ' 00:00:00') AND NOW()
                             GROUP BY AREACODE ) R1
                           ON L.AREACODE = R1.AREACODE
                 LEFT JOIN ( SELECT AREACODE
                                  , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN LSEQ END) AS DANGERCNT
                                  , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN LSEQ END) AS WARNINGCNT
                             FROM V_ALL_SENSOR_LOG_MAP
                             WHERE REGDATE BETWEEN CONCAT(DATE(NOW() - INTERVAL 1 DAY), ' 00:00:00') AND CONCAT(DATE(NOW() - INTERVAL 1 DAY), ' 23:59:59')
                             GROUP BY AREACODE ) R2
                           ON L.AREACODE = R2.AREACODE
        WHERE L.AREACODE != 'AREA_000001'
    </select>

    <select id="LIST_TODAY_GU_EVENT" parameterType="map" resultType="map">
        SELECT L.GUCODE
             , L.GUNAME
             , COALESCE(R1.DANGERCNT, 0) AS THISDANGERCNT
             , COALESCE(R1.WARNINGCNT, 0) AS THISWARNINGCNT
             , COALESCE(R2.DANGERCNT, 0) AS THATDANGERCNT
             , COALESCE(R2.WARNINGCNT, 0) AS THATWARNINGCNT
        FROM ( SELECT GUCODE, GUNAME FROM F_GUCODE WHERE USEYN = 'Y' ) L
                 LEFT JOIN ( SELECT DISTINCT GUCODE
                                           , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN LSEQ END) AS DANGERCNT
                                           , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN LSEQ END) AS WARNINGCNT
                             FROM V_ALL_SENSOR_LOG_MAP
                             WHERE REGDATE BETWEEN CONCAT(DATE(NOW()), ' 00:00:00') AND NOW()
                               AND AREACODE != 'AREA_000001'
                             GROUP BY GUCODE ) R1
                           ON L.GUCODE = R1.GUCODE
                 LEFT JOIN ( SELECT DISTINCT GUCODE
                                           , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN LSEQ END) AS DANGERCNT
                                           , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN LSEQ END) AS WARNINGCNT
                             FROM V_ALL_SENSOR_LOG_MAP
                             WHERE REGDATE BETWEEN CONCAT(DATE(NOW() - INTERVAL 1 DAY), ' 00:00:00') AND CONCAT(DATE(NOW() - INTERVAL 1 DAY), ' 23:59:59')
                               AND AREACODE != 'AREA_000001'
                             GROUP BY GUCODE ) R2
                           ON L.GUCODE = R2.GUCODE
    </select>
    <!-- ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->

    <select id="SELECT_KWH_STAT" parameterType="map" resultType="map">
        SELECT A.USEKWH AS YESTERDAYUSEKWH
             , B.USEKWH AS LASTWEEKUSEKWH
             , C.USEKWH AS LASTMONTHUSEKWH
        FROM ( SELECT SUM(SNSRKWHDAILY) AS USEKWH FROM F_CRN_AREA_ELEC_DAILY_STAT WHERE SDATE = DATE(NOW() - INTERVAL 1 DAY) ) A
             , ( SELECT SUM(SNSRKWHDAILY) AS USEKWH FROM F_CRN_AREA_ELEC_DAILY_STAT WHERE WEEK(SDATE) = WEEK(NOW() - INTERVAL 7 DAY) ) B
             , ( SELECT SUM(SNSRKWHDAILY) AS USEKWH FROM F_CRN_AREA_ELEC_DAILY_STAT WHERE DATE_FORMAT(SDATE, '%Y-%m') = DATE_FORMAT(NOW() - INTERVAL 1 MONTH, '%Y-%m') ) C
    </select>

    <select id="SELECT_CURR_KWH_STAT" parameterType="map" resultType="map">
        SELECT S.STRCNT
             , I.SNSRCNT
             , A.USEKWH AS YESTERDAYUSEKWH
             , B.USEKWH AS TODAYUSEKWH
             , (B.USEKWH / A.USEKWH) * 100 AS USEPER
        FROM ( SELECT COUNT(*) AS STRCNT FROM F_STORE WHERE USEYN = 'Y' AND DELYN = 'N' ) S
           , ( SELECT COUNT(*) AS SNSRCNT FROM F_SENSOR_INFO WHERE DELYN = 'N' ) I
           , ( SELECT SUM(SNSRKWHDAILY) AS USEKWH FROM F_CRN_AREA_ELEC_DAILY_STAT WHERE SDATE = DATE(NOW() - INTERVAL 1 DAY) ) A
             , ( SELECT SUM(USEKWH) AS USEKWH FROM F_CRN_AREA_KWH_TODAY_STAT ) B
    </select>

    <select id="LIST_GU_MAP_KWH_STAT" parameterType="map" resultType="map">
        SELECT L.GUCODE
             , COALESCE(A.USEKWH, 0) AS THATWEEKUSEKWH
             , COALESCE(B.USEKWH, 0) AS THISWEEKUSEKWH
        FROM ( SELECT DISTINCT GUCODE FROM F_GUCODE WHERE GRPCODE = '042' AND USEYN = 'Y' ) L
                 LEFT JOIN ( SELECT GUCODE, SUM(SNSRKWHDAILY) AS USEKWH
                             FROM F_CRN_AREA_ELEC_DAILY_STAT
                             WHERE WEEKOFYEAR(SDATE) = WEEKOFYEAR(NOW() - INTERVAL 7 DAY)
                             GROUP BY GUCODE ) A
                           ON L.GUCODE = A.GUCODE
                 LEFT JOIN ( SELECT SS.GUCODE, COALESCE(SUM(USEKWH), 0) AS USEKWH
                             FROM ( SELECT GUCODE, SUM(SNSRKWHDAILY) AS USEKWH
                                    FROM F_CRN_AREA_ELEC_DAILY_STAT
                                    WHERE WEEKOFYEAR(SDATE) = WEEKOFYEAR(NOW())
                                    GROUP BY GUCODE
                                    UNION ALL
                                    SELECT GUCODE, SUM(USEKWH) AS USEKWH
                                    FROM F_CRN_AREA_KWH_TODAY_STAT
                                    WHERE DATETIME BETWEEN CONCAT(DATE(NOW()), ' 00') AND NOW()
                                    GROUP BY GUCODE ) SS
                             GROUP BY SS.GUCODE ) B
                           ON L.GUCODE = B.GUCODE
--          WHERE L.GUCODE != '30200'
        ORDER BY L.GUCODE
    </select>

    <select id="LIST_GU_MONTH_KWH_STAT" parameterType="map" resultType="map">
        SELECT DISTINCT L.GUCODE
                      , A.USEKWH AS THATMONTHUSEKWH
                      , B.USEKWH AS THISMONTHUSEKWH
                      , (B.USEKWH / A.USEKWH) * 100 AS USEPER
        FROM ( SELECT DISTINCT GUCODE, AREACODE FROM F_LEVEL_AREA WHERE AREALEVEL = 1 AND USEYN = 'Y' AND DELYN = 'N' ) L
                 LEFT JOIN ( SELECT GUCODE, SUM(SNSRKWHDAILY) AS USEKWH
                             FROM F_CRN_AREA_ELEC_DAILY_STAT
                             WHERE DATE_FORMAT(SDATE, '%Y-%m') = DATE_FORMAT(NOW() - INTERVAL 1 MONTH, '%Y-%m')
                             GROUP BY GUCODE ) A
                           ON L.GUCODE = A.GUCODE
                 LEFT JOIN ( SELECT SS.GUCODE, COALESCE(SUM(SS.USEKWH), 0) AS USEKWH
                             FROM ( SELECT GUCODE, SUM(SNSRKWHDAILY) AS USEKWH
                                    FROM F_CRN_AREA_ELEC_DAILY_STAT
                                    WHERE DATE_FORMAT(SDATE, '%Y-%m') = DATE_FORMAT(NOW() - INTERVAL 1 MONTH, '%Y-%m')
                                    GROUP BY GUCODE
                                    UNION ALL
                                    SELECT GUCODE, SUM(USEKWH) AS USEKWH
                                    FROM F_CRN_AREA_KWH_TODAY_STAT
                                    WHERE DATETIME BETWEEN CONCAT(DATE(NOW()), ' 00') AND NOW()
                                    GROUP BY GUCODE ) SS
                             GROUP BY SS.GUCODE ) B
                           ON L.GUCODE = B.GUCODE
        WHERE L.GUCODE != '30200'
        ORDER BY L.GUCODE
    </select>

    <select id="LIST_GU_AREA_KWH_STAT" parameterType="map" resultType="map">
        SELECT A.GUCODE
             , A.GUNAME
             , A.AREACODE
             , A.AREANAME
             , A.USEKWH AS THATMONTHUSEKWH
             , COALESCE(B.USEKWH, 0) AS THISMONTHUSEKWH
             , ( CASE WHEN A.USEKWH = 0 AND COALESCE(B.USEKWH, 0) != 0 THEN 100
                      WHEN COALESCE(B.USEKWH, 0) = 0 THEN 0
                      ELSE (COALESCE(B.USEKWH, 0) / A.USEKWH) * 100
            END ) AS USEPER
        FROM ( SELECT L.GUCODE
                    , L.GUNAME
                    , L.AREACODE
                    , L.AREANAME
                    , COALESCE(R.USEKWH, 0) AS USEKWH
               FROM ( SELECT A.GUCODE, B.GUNAME, A.AREACODE, A.AREANAME
                      FROM F_LEVEL_AREA A
                               LEFT JOIN F_GUCODE B
                                         ON A.GUCODE = B.GUCODE
                      WHERE A.AREALEVEL = 1 AND A.USEYN = 'Y' AND A.DELYN = 'N' ) L
                        LEFT JOIN ( SELECT AREACODE
                                         , SUM(SNSRKWHDAILY) AS USEKWH
                                    FROM F_CRN_AREA_ELEC_DAILY_STAT SS
                                    WHERE DATE_FORMAT(SDATE, '%Y-%m') = DATE_FORMAT(NOW() - INTERVAL 1 MONTH, '%Y-%m')
                                    GROUP BY AREACODE ) R
                                  ON L.AREACODE = R.AREACODE
               WHERE L.AREACODE != 'AREA_000001'
             ) A
                 LEFT JOIN ( SELECT SS.AREACODE, COALESCE(SUM(SS.USEKWH), 0) AS USEKWH
                             FROM ( SELECT AREACODE
                                         , SUM(SNSRKWHDAILY) AS USEKWH
                                    FROM F_CRN_AREA_ELEC_DAILY_STAT SS
                                    WHERE DATE_FORMAT(SDATE, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
                                      AND AREACODE != 'AREA_000001'
                                    GROUP BY AREACODE
                                    UNION ALL
                                    SELECT AREACODE, SUM(USEKWH) AS USEKWH
                                    FROM F_CRN_AREA_KWH_TODAY_STAT
                                    WHERE DATETIME BETWEEN CONCAT(DATE(NOW()), ' 00') AND NOW()
                                      AND AREACODE != 'AREA_000001'
                                    GROUP BY AREACODE ) SS
                             GROUP BY SS.AREACODE ) B
                           ON A.AREACODE = B.AREACODE
        ORDER BY A.GUCODE, COALESCE(B.USEKWH, 0) DESC
    </select>

</mapper>
