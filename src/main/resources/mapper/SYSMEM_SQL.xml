<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.fscom.firsens.sys.repository.SYSMemRepo">
    <select id="SELECT_CNT_SYS_MEM" parameterType="SYSMemDomain" resultType="int">
        SELECT COUNT(*)
        FROM ( SELECT @ROWNUM := @ROWNUM + 1         AS rowNum
                    , A.*
                 FROM ( SELECT FM.USERID             AS userId
                             , FM.USERID             AS userIdKey
                             , FM.MEMNAME            AS memName
                             , FM.MEMLEVEL           AS memLevel
                             , FM.REGDATE            AS regDate
                             , FM.MEMRSNTDATE        AS memRsntDate
                             , FM.USEYN              AS useYn
                             , FM.DELYN              AS delYn
                             , FM.MEMISLEAVE         AS memIsLeave
                             , FM.LOGINFAILCNT       AS loginFailCnt
                          FROM F_MEMBER FM
                         WHERE 1 = 1
                         <if test='searchWrd != null and searchWrd !=""'>
                           AND ( FM.USERID  LIKE CONCAT('%', #{searchWrd}, '%') OR FM.MEMNAME LIKE CONCAT('%', #{searchWrd}, '%') )
                         </if>
                         AND FM.USEYN = #{useYn}
                         AND FM.DELYN = #{delYn}
                         AND FM.MEMISLEAVE = #{memIsLeave}
                         AND FM.MEMRCVSMS = #{memRcvSms}
<!--                         <if test="#fn=chkNotEmpty, #fn(useYn)">-->
<!--                           -->
<!--                         </if>-->
                      ) A,
                ( SELECT @ROWNUM := 0 ) R
            ) Z
    </select>

    <!-- 회원목록 조회 -->
    <select id="SELECT_LIST_SYS_MEM" parameterType="SYSMemDomain" resultType="SYSMemDomain">
        SELECT Z.*
          FROM ( SELECT @ROWNUM := @ROWNUM + 1          AS rowNum
                      , A.*
                   FROM ( SELECT FM.USERID              AS userId
                               , FM.USERID              AS userIdKey
                               , FM.MEMNAME             AS memName
                               , FM.MEMEMAIL            AS memEmail
                               , FM.MEMTEL              AS memTel
                               , FM.MEMMOBILE           AS memMobile
                               , FM.MEMLEVEL            AS memLevel
                               , FM.MEMRCVSMS           AS memRcvSms
                               , FM.MEMRCVPUSH          AS memRcvPush
                               , DATE_FORMAT(FM.REGDATE, '%Y-%m-%d %H:%i:%s')             AS regDate
                               , DATE_FORMAT(FM.MEMRSNTDATE, '%Y-%m-%d %H:%i:%s')         AS memRsntDate
                               , FM.USEYN               AS useYn
                               , FM.MEMMEMO             AS memMemo
                               , FM.MEMISLEAVE          AS memIsLeave
                               , FM.LOGINFAILCNT        AS loginFailCnt
                               , (SELECT COUNT(*) FROM F_STORE WHERE USERID = FM.USERID)  AS strCnt
                            FROM F_MEMBER FM
                           WHERE 1 = 1
                           <if test='searchWrd != null and searchWrd !=""'>
                             AND ( FM.USERID  LIKE CONCAT('%', #{searchWrd}, '%') OR FM.MEMNAME LIKE CONCAT('%', #{searchWrd}, '%') )
                           </if>
                             AND FM.USEYN = #{useYn}
                             AND FM.DELYN = #{delYn}
                             AND FM.MEMISLEAVE = #{memIsLeave}
                             AND FM.MEMRCVSMS = #{memRcvSms}
                        ORDER BY FM.REGDATE DESC, FM.MEMNAME ASC
                        ) A,
                        ( SELECT @ROWNUM := 0 ) R
                ORDER BY rowNum desc
            ) Z
      LIMIT #{page}, #{sizePerPage}
    </select>

    <select id="SELECT_MODAL_SYS_MEM" parameterType="String" resultType="SYSMemDomain">
        SELECT FM.USERID, FM.MEMNAME
          FROM F_MEMBER FM
         WHERE 1 = 1
        <if test='searchWrd != null and searchWrd !=""'>
            AND ( FM.USERID  LIKE CONCAT('%', #{searchWrd}, '%') OR FM.MEMNAME LIKE CONCAT('%', #{searchWrd}, '%') )
        </if>
        ORDER BY FM.REGDATE DESC, FM.MEMNAME ASC
    </select>

    <select id="SELECT_CHK_MEM_ID" parameterType="SYSMemDomain" resultType="int">
        SELECT COUNT(*)
        FROM F_MEMBER
        WHERE USERID = #{userId}
    </select>

    <insert id="INSERT_SYS_MEM" parameterType="SYSMemDomain">
        INSERT INTO F_MEMBER (
                    USERID
                  , MEMPWD
                  , MEMNAME
                  , MEMEMAIL
                  , MEMTEL
                  , MEMMOBILE
                  , MEMLEVEL
                  , MEMRCVSMS
                  , MEMRCVPUSH
                  , REGDATE
                  , MEMRSNTDATE
                  , MEMISLEAVE
                  , USEYN
                  , DELYN
                  , MEMMEMO
                  , PWCHANGE
                  , GROUPUSE
        ) VALUES (
                    #{ userId      }
                  , #{ memPwd      }
                  , #{ memName     }
                  , #{ memEmail    }
                  , #{ memTel      }
                  , #{ memMobile   }
                  , 0
                  , #{ memRcvSms   }
                  , #{ memRcvPush  }
                  , NOW()
                  , NOW()
                  , #{ memIsLeave }
                  , #{ useYn }
                  , #{ delYn }
                  , #{ memMemo }
                  , 'Y'
                  , #{ groupUse }
                 )
    </insert>

    <!-- 단일 회원 정보 조회 -->
    <select id="SELECT_SYS_MEM" parameterType="SYSMemDomain" resultType="SYSMemDomain">
        SELECT FM.USERID           AS userId
             , FM.MEMNAME          AS memName
             , FM.MEMEMAIL         AS memEmail
             , FM.MEMTEL           AS memTel
             , FM.MEMMOBILE        AS memMobile
             , FM.GRPCODE          AS grpCode
             , FG.GRPNAME          AS grpName
             , FM.GROUPUSE         AS groupUse
             , FM.MEMLEVEL         AS memLevel
             , FM.MEMRCVEMAIL      AS memRcvEmail
             , FM.MEMRCVSMS        AS memRcvSms
             , FM.MEMRCVPUSH       AS memRcvPush
             , DATE_FORMAT(FM.REGDATE, '%Y-%m-%d %H:%i:%s')          AS regDate
             , DATE_FORMAT(FM.MEMRSNTDATE, '%Y-%m-%d %H:%i:%s')      AS memRsntDate
             , FM.USEYN            AS useYn
             , FM.DELYN            AS delYn
             , FM.MEMISLEAVE       AS memIsLeave
             , FM.MEMMEMO          AS memMemo
             , FM.LOGINFAILCNT     AS loginFailCnt
        FROM F_MEMBER FM
                 LEFT JOIN F_GROUP FG
                           ON FM.GRPCODE = FG.GRPCODE
        WHERE FM.USERID = #{userId}
        GROUP BY userId
    </select>

    <!-- 회원 수정 -->
    <update id="UPDATE_SYS_MEM" parameterType="SYSMemDomain">
        UPDATE F_MEMBER
           SET MEMNAME    = #{ memName   }
             , MEMTEL       = #{ memTel    }
             , MEMMOBILE    = #{ memMobile }
             , MEMEMAIL     = #{ memEmail  }
             , MEMLEVEL     = #{ memLevel  }
             , MEMRCVSMS    = #{ memRcvSms  }
             , MEMRCVPUSH   = #{ memRcvPush  }
             , MEMISLEAVE   = #{ memIsLeave  }
             , USEYN        = #{ useYn  }
             , DELYN        = #{ delYn  }
             , GROUPUSE     = #{ groupUse  }
             , MEMMEMO      = #{ memMemo  }
           <if test='memPwd != ""'>
             , MEMPWD = #{memPwd}
           </if>
         WHERE USERID = #{ userId }
    </update>

    <delete id="DELETE_SYS_MEM" parameterType="SYSMemDomain">
        DELETE FROM F_MEMBER
         WHERE USERID = #{userId}
    </delete>

</mapper>
