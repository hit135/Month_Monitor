<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.fscom.firsens.mng.challenge.repository.MCMainRepo">

    <!-- 오늘 종합 현황 (전체, 경고, 주의, 끊김) -->
    <select id="LIST_MCM_TODAY_TOTAL_STATE" parameterType="map" resultType="map">
        <![CDATA[
        SELECT
            'TODAY' TERM
            , B.TYPE
            , B.ORDERNUM
            , (CASE
                   WHEN B.TYPE = 'TOTAL' THEN A.TOTAL
                   WHEN B.TYPE = 'DISCON' THEN A.DISCON
               END) AS CNT
        FROM
            (SELECT
                 COUNT(DISTINCT I.SNSRSEQ) AS TOTAL
                 , SUM(ISDISCONN) AS DISCON
             FROM
                 (SELECT
                      SNSRSEQ
                      , STRCODE
                      , (CASE WHEN DATARCVTIME < NOW() - INTERVAL 1 HOUR THEN 1 ELSE 0 END) AS ISDISCONN
                  FROM
                      F_SENSOR_INFO
                  WHERE
                      CONCAT(DELYN, STRCODE) LIKE 'NFS_STR_%'
                 ) I
                     LEFT JOIN F_STORE S
                         ON I.STRCODE = S.STRCODE
             WHERE
                 CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
                 AND S.STRCODE != 'FS_STR_0000000001859'
            ) A
            ,
            (SELECT 'TOTAL' AS TYPE, 1 AS ORDERNUM
             UNION ALL SELECT 'DISCON', 2) B
        GROUP BY
            B.TYPE

        UNION

        SELECT
            B.TERM
            , B.TYPE
            , B.ORDERNUM
            , (CASE
                   WHEN CONCAT(B.TERM, '|', B.TYPE) = 'TODAY|WARN' THEN A.TODAYWARN
                   WHEN CONCAT(B.TERM, '|', B.TYPE) = 'TODAY|DANGER' THEN A.TODAYDANGER
                   WHEN CONCAT(B.TERM, '|', B.TYPE) = 'COUNT|WARN' THEN A.COUNTWARN
                   WHEN CONCAT(B.TERM, '|', B.TYPE) = 'COUNT|DANGER' THEN A.COUNTDANGER
               END) AS CNT
        FROM
            (SELECT
                 COUNT(DISTINCT CASE WHEN INSTR(L.ALMFLAG, '2') > 0 THEN I.SNSRSEQ END) AS TODAYDANGER
                 , COUNT(DISTINCT CASE WHEN INSTR(L.ALMFLAG, '1') > 0 THEN I.SNSRSEQ END) AS TODAYWARN
                 , SUM(CASE WHEN INSTR(L.ALMFLAG, '2') > 0 THEN 1 ELSE 0 END) AS COUNTDANGER
                 , SUM(CASE WHEN INSTR(L.ALMFLAG, '1') > 0 THEN 1 ELSE 0 END) AS COUNTWARN
             FROM
                 (SELECT
                      SNSRSEQ, REGDATE, CONCAT(OCALM, IGOALM, IGRALM) AS ALMFLAG
                  FROM
                      F_SENSOR_LOG
                  WHERE
                      REGDATE > CURDATE()
                      AND OCALM + IGOALM + IGRALM > 0
                      AND ISSIMUL = 0
                 ) L
                     LEFT JOIN F_SENSOR_INFO I
                         ON L.SNSRSEQ = I.SNSRSEQ
                     LEFT JOIN F_STORE S
                         ON I.STRCODE = S.STRCODE
             WHERE
                 CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
                 AND S.STRCODE != 'FS_STR_0000000001859'
                 AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
            ) A
            ,
            (SELECT 'TODAY' AS TERM, 'WARN' AS TYPE, 3 AS ORDERNUM
             UNION ALL SELECT 'COUNT', 'WARN', 4
             UNION ALL SELECT 'TODAY', 'DANGER', 5
             UNION ALL SELECT 'COUNT', 'DANGER', 6) B
        GROUP BY
            B.TERM, B.TYPE
        ORDER BY
            ORDERNUM
        ]]>
    </select>

    <!-- 오늘 구별, 시장별 센서 현황 (상점, 센서, 경고, 주의, 끊김) -->
    <select id="LIST_MCM_TODAY_GU_AREA_STATE" parameterType="map" resultType="map">
        <![CDATA[
        SELECT
            1 AS LEVEL
            , S.GUCODE AS CODE
            , S.GUNAME AS NAME
            , S.SNSRCNT AS SENSOR
            , S.STRCNT AS STORE
            , S.DANGERSNSRCNT AS DANGER
            , S.WARNSNSRCNT AS WARN
            , S.SNSRDISNCNT AS DISCON
            , NULL AS UPCODE
            , S.DANGERSNSRCNT * 10000 + S.WARNSNSRCNT AS ORDERNUM
        FROM
            (SELECT
                 S.GRPCODE
                 , G.GUCODE
                 , G.GUNAME
                 , COALESCE(COUNT(DISTINCT S.STRCODE), 0) AS STRCNT
                 , COALESCE(COUNT(DISTINCT I.SNSRSEQ), 0) AS SNSRCNT
                 , COALESCE(COUNT(DISTINCT CASE WHEN I.DATARCVTIME < NOW() - INTERVAL 1 HOUR THEN I.SNSRSEQ END), 0) AS SNSRDISNCNT
                 , COALESCE(SUM(I.DANGERSNSRCNT), 0) AS DANGERSNSRCNT
                 , COALESCE(SUM(I.WARNSNSRCNT), 0) AS WARNSNSRCNT
             FROM
                 (SELECT GRPCODE, GUCODE, GUNAME FROM F_GUCODE WHERE CONCAT(USEYN, GRPCODE, GUCODE) LIKE 'Y04230%') G
                     LEFT JOIN (SELECT
                                    GUCODE, AREACODE
                                FROM
                                    F_LEVEL_AREA
                                WHERE
                                    CONCAT(AREALEVEL, USEYN, DELYN, GUCODE) LIKE '1YN30%'
                               ) A
                         ON G.GUCODE = A.GUCODE
                     LEFT JOIN (SELECT
                                    AREACODE, STRCODE, GRPCODE
                                FROM
                                    F_STORE
                                WHERE
                                    CONCAT(USEYN, DELYN, GRPCODE) = 'YN042'
                                    AND STRCODE != 'FS_STR_0000000001859'
                               ) S
                         ON A.AREACODE = S.AREACODE
                     LEFT JOIN (SELECT
                                    I1.STRCODE, I1.SNSRSEQ, I1.DATARCVTIME, I2.DANGERSNSRCNT, I2.WARNSNSRCNT
                                FROM
                                    (SELECT STRCODE, SNSRSEQ, DATARCVTIME FROM F_SENSOR_INFO WHERE CONCAT(DELYN, STRCODE) LIKE 'NFS_STR_%') I1
                                        LEFT JOIN (SELECT
                                                       SNSRSEQ
                                                       , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN SNSRSEQ END) AS DANGERSNSRCNT
                                                       , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN SNSRSEQ END) AS WARNSNSRCNT
                                                   FROM
                                                       F_SENSOR_LOG
                                                   WHERE
                                                       REGDATE > CURDATE()
                                                       AND OCALM + IGOALM + IGRALM > 0
                                                       AND ISSIMUL = 0
                                                   GROUP BY
                                                       SNSRSEQ
                                                  ) I2
                                            ON I1.SNSRSEQ = I2.SNSRSEQ
                                GROUP BY
                                    I1.SNSRSEQ
                               ) I
                         ON S.STRCODE = I.STRCODE
             GROUP BY
                 G.GUCODE
            ) S

        UNION

        SELECT
            2 AS LEVEL
            , S.AREACODE AS CODE
            , S.AREANAME AS NAME
            , S.SNSRCNT AS SENSOR
            , S.STRCNT AS STORE
            , S.DANGERSNSRCNT AS DANGER
            , S.WARNSNSRCNT AS WARN
            , S.SNSRDISNCNT AS DISCON
            , S.GUCODE AS UPCODE
            , 0 - (S.DANGERSNSRCNT * 10000 + S.WARNSNSRCNT) AS ORDERNUM
        FROM
            (SELECT
                 G.GUCODE
                 , A.AREACODE
                 , A.AREANAME
                 , COALESCE(COUNT(DISTINCT S.STRCODE), 0) AS STRCNT
                 , COALESCE(COUNT(DISTINCT I.SNSRSEQ), 0) AS SNSRCNT
                 , COALESCE(COUNT(DISTINCT CASE WHEN I.DATARCVTIME < NOW() - INTERVAL 1 HOUR THEN I.SNSRSEQ END), 0) AS SNSRDISNCNT
                 , COALESCE(SUM(I.DANGERSNSRCNT), 0) AS DANGERSNSRCNT
                 , COALESCE(SUM(I.WARNSNSRCNT), 0) AS WARNSNSRCNT
             FROM
                 (SELECT GUCODE, AREACODE, AREANAME FROM F_LEVEL_AREA WHERE CONCAT(AREALEVEL, USEYN, DELYN, GUCODE) LIKE '1YN30%') A
                     LEFT JOIN F_GUCODE G
                         ON G.GUCODE = A.GUCODE
                     LEFT JOIN (SELECT
                                    AREACODE, STRCODE, GRPCODE
                                FROM
                                    F_STORE
                                WHERE
                                    CONCAT(USEYN, DELYN, GRPCODE) = 'YN042'
                                    AND STRCODE != 'FS_STR_0000000001859'
                               ) S
                         ON A.AREACODE = S.AREACODE
                     LEFT JOIN (SELECT
                                    I1.STRCODE, I1.SNSRSEQ, I1.DATARCVTIME, I2.DANGERSNSRCNT, I2.WARNSNSRCNT
                                FROM
                                    (SELECT STRCODE, SNSRSEQ, DATARCVTIME FROM F_SENSOR_INFO WHERE CONCAT(DELYN, STRCODE) LIKE 'NFS_STR_%') I1
                                        LEFT JOIN (SELECT
                                                       SNSRSEQ
                                                       , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN SNSRSEQ END) AS DANGERSNSRCNT
                                                       , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN SNSRSEQ END) AS WARNSNSRCNT
                                                   FROM
                                                       F_SENSOR_LOG
                                                   WHERE
                                                       REGDATE > CURDATE()
                                                       AND OCALM + IGOALM + IGRALM > 0
                                                       AND ISSIMUL = 0
                                                   GROUP BY
                                                       SNSRSEQ
                                                  ) I2
                                            ON I1.SNSRSEQ = I2.SNSRSEQ
                                GROUP BY
                                    I1.SNSRSEQ
                               ) I
                         ON S.STRCODE = I.STRCODE
             WHERE
                 CONCAT(G.USEYN, G.GRPCODE, G.GUCODE) LIKE 'Y04230%'
             GROUP BY
                 A.AREACODE
            ) S
        ORDER BY
            LEVEL, ORDERNUM DESC
        ]]>
    </select>

    <!-- 점검내역 목록 -->
    <select id="LIST_MCM_CHECK_SENSOR" parameterType="map" resultType="map">
        SELECT
            D.AREACODE, D.AREANAME, B.STRCODE, B.SNSRID, B.SNSRNICK, A.STATE, A.CNT
        FROM
            (SELECT
                 A.SNSRID, 'CHECK' AS STATE, COUNT(*) AS CNT
             FROM
                 F_SENSOR_CHECK A
             WHERE
                 A.CHECKSTAT = 'ING'
             GROUP BY
                 A.SNSRID
            ) A
                LEFT JOIN F_SENSOR_INFO B
                    ON A.SNSRID = B.SNSRID
                LEFT JOIN F_STORE C
                    ON B.STRCODE = C.STRCODE
                LEFT JOIN F_LEVEL_AREA D
                    ON C.AREACODE = D.AREACODE
        WHERE
            CONCAT(D.AREALEVEL, D.USEYN, D.DELYN, D.GUCODE) LIKE '1YN30%'
            AND CONCAT(C.USEYN, C.DELYN, C.GRPCODE) = 'YN042'
            AND C.STRCODE != 'FS_STR_0000000001859'
            AND CONCAT(B.DELYN, B.STRCODE) LIKE 'NFS_STR_%'
        ORDER BY
            A.STATE, A.CNT DESC
    </select>

    <!-- 오늘 상태이상 센서 목록 -->
    <select id="LIST_MCM_TODAY_ABNORMAL_SENSOR" parameterType="map" resultType="map">
        SELECT
            S.AREACODE, S.AREANAME, S.STRCODE, S.SNSRSEQ, S.SNSRNICK, S.STATE, S.CNT
        FROM
            (SELECT
                 A.AREACODE
                 , A.AREANAME
                 , S.STRCODE
                 , I.SNSRSEQ
                 , I.SNSRNICK
                 , B.STATE
                 , (CASE
                        WHEN B.STATE = 'DANGER' THEN COALESCE(L.DANGERCNT, 0)
                        WHEN B.STATE = 'WARN' THEN COALESCE(L.WARNCNT, 0)
                        WHEN B.STATE = 'BROKEN' THEN COALESCE(D.BROKENCNT, 0)
                    END) AS CNT
             FROM
                 (SELECT STRCODE, SNSRSEQ, SNSRNICK FROM F_SENSOR_INFO WHERE CONCAT(DELYN, STRCODE) LIKE 'NFS_STR_%') I
                     LEFT JOIN F_STORE S
                         ON I.STRCODE = S.STRCODE
                     LEFT JOIN F_LEVEL_AREA A
                         ON S.AREACODE = A.AREACODE
                     LEFT JOIN (SELECT
                                    SNSRSEQ, COUNT(*) AS BROKENCNT
                                FROM
                                    F_SENSOR_DATA
                                WHERE
                                    SNSRRCVTIME > CURDATE()
                                    AND SNSRIGO > 50
                                    AND ISSIMUL = 0
                                GROUP BY
                                    SNSRSEQ
                               ) D
                         ON I.SNSRSEQ = D.SNSRSEQ
                     LEFT JOIN (SELECT
                                    SNSRSEQ
                                    , SUM(CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN 1 ELSE 0 END) AS DANGERCNT
                                    , SUM(CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN 1 ELSE 0 END) AS WARNCNT
                                FROM
                                    F_SENSOR_LOG
                                WHERE
                                    REGDATE > CURDATE()
                                    AND OCALM + IGOALM + IGRALM > 0
                                    AND ISSIMUL = 0
                                GROUP BY
                                    SNSRSEQ
                               ) L
                         ON I.SNSRSEQ = L.SNSRSEQ
                 ,
                 (SELECT 'DANGER' AS STATE
                  UNION ALL SELECT 'WARN'
                  UNION ALL SELECT 'BROKEN') B
             WHERE
                 CONCAT(A.AREALEVEL, A.USEYN, A.DELYN, A.GUCODE) LIKE '1YN30%'
                 AND CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
                 AND S.STRCODE != 'FS_STR_0000000001859'
            ) S
        WHERE
            S.CNT > 0
        ORDER BY
            S.STATE, S.CNT DESC
    </select>

    <!-- 오늘 시장 현황 (전체, 경고, 주의, 끊김) -->
    <select id="LIST_MCM_TODAY_AREA_STATE" parameterType="map" resultType="map">
        <![CDATA[
        SELECT
            A.AREACODE
            , A.AREANAME
            , COALESCE(COUNT(DISTINCT S.STRCODE), 0) AS TOTAL
            , COALESCE(COUNT(DISTINCT CASE WHEN I.DATARCVTIME < NOW() - INTERVAL 1 HOUR THEN I.SNSRSEQ END), 0) AS DISCON
            , COALESCE(SUM(I.DANGERCNT), 0) AS DANGER
            , COALESCE(SUM(I.WARNCNT), 0) AS WARN
        FROM
            (SELECT
                 AREACODE, AREANAME
             FROM
                 F_LEVEL_AREA
             WHERE
                 CONCAT(AREALEVEL, USEYN, DELYN, GUCODE) LIKE '1YN30%'
                 AND AREACODE = #{areacode}
            ) A
                LEFT JOIN (SELECT
                               AREACODE, STRCODE
                           FROM
                               F_STORE
                           WHERE
                               CONCAT(USEYN, DELYN, GRPCODE) = 'YN042'
                               AND STRCODE != 'FS_STR_0000000001859'
                          ) S
                    ON A.AREACODE = S.AREACODE
                LEFT JOIN (SELECT
                               I1.STRCODE, I1.SNSRSEQ, I1.DATARCVTIME, I2.DANGERCNT, I2.WARNCNT
                           FROM
                               (SELECT STRCODE, SNSRSEQ, DATARCVTIME FROM F_SENSOR_INFO WHERE CONCAT(DELYN, STRCODE) LIKE 'NFS_STR_%') I1
                                   LEFT JOIN (SELECT
                                                  SNSRSEQ
                                                  , SUM(CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN 1 ELSE 0 END) AS DANGERCNT
                                                  , SUM(CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN 1 ELSE 0 END) AS WARNCNT
                                              FROM
                                                  F_SENSOR_LOG
                                              WHERE
                                                  REGDATE > CURDATE()
                                                  AND OCALM + IGOALM + IGRALM > 0
                                                  AND ISSIMUL = 0
                                              GROUP BY
                                                  SNSRSEQ
                                             ) I2
                                       ON I1.SNSRSEQ = I2.SNSRSEQ
                           GROUP BY
                               I1.SNSRSEQ
                          ) I
                    ON S.STRCODE = I.STRCODE
        ]]>
    </select>

    <!-- 오늘 시장 내 상점 현황 (경고, 주의, 끊김, 센서) -->
    <select id="LIST_MCM_TODAY_AREA_STORE_STATE" parameterType="map" resultType="map">
        <![CDATA[
        SELECT
            A.AREACODE
            , S.STRCODE
            , S.STRNAME
            , COALESCE(COUNT(DISTINCT I.SNSRSEQ), 0) AS SNSRCOUNT
            , COALESCE(COUNT(DISTINCT CASE WHEN I.DATARCVTIME < NOW() - INTERVAL 1 HOUR THEN I.SNSRSEQ END), 0) AS CON
            , COALESCE(SUM(I.DANGERCNT), 0) AS DANGER
            , COALESCE(SUM(I.WARNCNT), 0) AS WARN
        FROM
            (SELECT
                 AREACODE, STRCODE, STRNAME
             FROM
                 F_STORE
             WHERE
                 CONCAT(USEYN, DELYN, GRPCODE) = 'YN042'
                 AND STRCODE != 'FS_STR_0000000001859'
                 AND AREACODE = #{areacode}
            ) S
                LEFT JOIN F_LEVEL_AREA A
                    ON S.AREACODE = A.AREACODE
                LEFT JOIN (SELECT
                               I1.STRCODE, I1.SNSRSEQ, I1.DATARCVTIME, I2.DANGERCNT, I2.WARNCNT
                           FROM
                               (SELECT STRCODE, SNSRSEQ, DATARCVTIME FROM F_SENSOR_INFO WHERE CONCAT(DELYN, STRCODE) LIKE 'NFS_STR_%') I1
                                   LEFT JOIN (SELECT
                                                  SNSRSEQ
                                                  , SUM(CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN 1 ELSE 0 END) AS DANGERCNT
                                                  , SUM(CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN 1 ELSE 0 END) AS WARNCNT
                                              FROM
                                                  F_SENSOR_LOG
                                              WHERE
                                                  REGDATE > CURDATE()
                                                  AND OCALM + IGOALM + IGRALM > 0
                                                  AND ISSIMUL = 0
                                              GROUP BY
                                                  SNSRSEQ
                                             ) I2
                                       ON I1.SNSRSEQ = I2.SNSRSEQ
                           GROUP BY
                               I1.SNSRSEQ
                          ) I
                    ON S.STRCODE = I.STRCODE
        WHERE
            CONCAT(A.AREALEVEL, A.USEYN, A.DELYN, A.GUCODE) LIKE '1YN30%'
        GROUP BY
            S.STRCODE
        ORDER BY
            DANGER DESC, WARN DESC, CON DESC, STRNAME
        ]]>
    </select>

    <!-- 오늘 시장 내 센서 현황 (경고, 주의, 끊김, 점검) -->
    <select id="LIST_MCM_TODAY_AREA_SENSOR_STATE" parameterType="map" resultType="map">
        <![CDATA[
        SELECT
            ROW_NUMBER() OVER () AS ROWNUM
            , S.STRCODE
            , S.STRNAME
            , I.SNSRID
            , TRIM(LEADING '0' FROM I.SNSRID) AS SNSRIDTRIM
            , I.SNSRNICK
            , CASE WHEN I.DATARCVTIME < NOW() - INTERVAL 1 HOUR THEN 1 ELSE 0 END AS CON
            , COALESCE(L.DANGERCNT, 0) AS DANGER
            , COALESCE(L.WARNCNT, 0) AS WARN
            , COALESCE(E.CHK, 0) AS CHK
        FROM
            (SELECT STRCODE, SNSRID, SNSRSEQ, SNSRNICK, DATARCVTIME FROM F_SENSOR_INFO WHERE CONCAT(DELYN, STRCODE) LIKE 'NFS_STR_%') I
                LEFT JOIN (SELECT
                               SNSRSEQ
                               , SUM(CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN 1 ELSE 0 END) AS DANGERCNT
                               , SUM(CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN 1 ELSE 0 END) AS WARNCNT
                           FROM
                               F_SENSOR_LOG
                           WHERE
                               REGDATE > CURDATE()
                               AND OCALM + IGOALM + IGRALM > 0
                               AND ISSIMUL = 0
                           GROUP BY
                               SNSRSEQ) L
                    ON I.SNSRSEQ = L.SNSRSEQ
                LEFT JOIN F_STORE S
                    ON I.STRCODE = S.STRCODE
                LEFT JOIN F_LEVEL_AREA A
                    ON S.AREACODE = A.AREACODE
                LEFT JOIN (SELECT
                               SNSRID, COUNT(*) AS CHK
                           FROM
                               F_SENSOR_CHECK
                           WHERE
                               CHECKSTAT = 'ING'
                           GROUP BY
                               SNSRID) E
                    ON I.SNSRID = E.SNSRID
        WHERE
            CONCAT(A.AREALEVEL, A.USEYN, A.DELYN, A.GUCODE) LIKE '1YN30%'
            AND CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
            AND S.STRCODE != 'FS_STR_0000000001859'
            AND A.AREACODE = #{areacode}
            AND S.STRCODE = #{strcode}
        GROUP BY
            I.SNSRID
        ORDER BY
            DANGER DESC, WARN DESC, CON DESC, SNSRID
        ]]>
    </select>

    <!-- 시장별 어제/오늘 데이터 추이 -->
    <select id="LIST_MCM_2DAYS_AREA_DATA_CHART" parameterType="map" resultType="map">
        SELECT
            '1' AS TYPE
            , CONCAT(SUBSTR(DATE_FORMAT(A.SNSRRCVTIME, '%H:%i'), 1, 4), '0') AS RCVTIME
            , COUNT(*) AS CNT
        FROM
            (SELECT
                 SNSRID, SNSRRCVTIME
             FROM
                 <choose>
                     <when test="day == 1">F_SENSOR_DATA_2021</when>
                     <otherwise>F_SENSOR_DATA</otherwise>
                 </choose>
             WHERE
                 SNSRRCVTIME > CURDATE() - INTERVAL 1 DAY
                 AND SNSRRCVTIME <![CDATA[<]]> CURDATE()
            ) A
                LEFT JOIN F_SENSOR_INFO B
                    ON A.SNSRID = B.SNSRID
                LEFT JOIN F_LEVEL_AREA C
                    ON B.AREACODE = C.AREACODE
        WHERE
            CONCAT(C.AREALEVEL, C.USEYN, C.DELYN, C.GUCODE) LIKE '1YN30%'
            AND CONCAT(B.DELYN, B.STRCODE) LIKE 'NFS_STR_%'
            AND B.STRCODE != 'FS_STR_0000000001859'
            AND C.AREACODE = #{areacode}
        GROUP BY
            2

        UNION

        SELECT
            '2' AS TYPE
            , CONCAT(SUBSTR(DATE_FORMAT(A.SNSRRCVTIME, '%H:%i'), 1, 4), '0') AS RCVTUNE
            , COUNT(*) AS CNT
        FROM
            (SELECT SNSRID, SNSRRCVTIME FROM F_SENSOR_DATA WHERE SNSRRCVTIME > CURDATE()) A
                LEFT JOIN F_SENSOR_INFO B
                    ON A.SNSRID = B.SNSRID
                LEFT JOIN F_LEVEL_AREA C
                    ON B.AREACODE = C.AREACODE
        WHERE
            CONCAT(C.AREALEVEL, C.USEYN, C.DELYN, C.GUCODE) LIKE '1YN30%'
            AND CONCAT(B.DELYN, B.STRCODE) LIKE 'NFS_STR_%'
            AND B.STRCODE != 'FS_STR_0000000001859'
            AND C.AREACODE = #{areacode}
        GROUP BY
            2
        ORDER BY
            TYPE, RCVTIME
    </select>

    <!-- 시장별 어제/오늘 경보 발생 추이 -->
    <select id="LIST_MCM_2DAYS_AREA_LOG_CHART" parameterType="map" resultType="map">
        SELECT
            '1' AS TYPE
            , CONCAT(SUBSTR(DATE_FORMAT(A.REGDATE, '%H:%i'), 1, 4), '0') AS RCVTIME
            , COUNT(*) AS CNT
        FROM
            (SELECT
                 SNSRID, REGDATE
             FROM
                 <choose>
                     <when test="day == 1">F_SENSOR_LOG_2021 A</when>
                     <otherwise>F_SENSOR_LOG A</otherwise>
                 </choose>
             WHERE
                 REGDATE > CURDATE() - INTERVAL 1 DAY
                 AND REGDATE <![CDATA[<]]> CURDATE()
                 AND INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0
            ) A
                LEFT JOIN F_SENSOR_INFO B
                    ON A.SNSRID = B.SNSRID
                LEFT JOIN F_LEVEL_AREA C
                    ON B.AREACODE = C.AREACODE
       WHERE
           CONCAT(C.AREALEVEL, C.USEYN, C.DELYN, C.GUCODE) LIKE '1YN30%'
           AND CONCAT(B.DELYN, B.STRCODE) LIKE 'NFS_STR_%'
           AND B.STRCODE != 'FS_STR_0000000001859'
           AND C.AREACODE = #{areacode}
       GROUP BY
           2

       UNION

       SELECT
           '2' AS TYPE
           , CONCAT(SUBSTR(DATE_FORMAT(A.REGDATE, '%H:%i'), 1, 4), '0') AS RCVTUNE
           , COUNT(*) AS CNT
       FROM
           (SELECT
                SNSRID, REGDATE
            FROM
                F_SENSOR_LOG
            WHERE
                REGDATE > CURDATE()
                AND INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0
           ) A
               LEFT JOIN F_SENSOR_INFO B
                   ON A.SNSRID = B.SNSRID
               LEFT JOIN F_LEVEL_AREA C
                   ON B.AREACODE = C.AREACODE
       WHERE
           CONCAT(C.AREALEVEL, C.USEYN, C.DELYN, C.GUCODE) LIKE '1YN30%'
           AND CONCAT(B.DELYN, B.STRCODE) LIKE 'NFS_STR_%'
           AND B.STRCODE != 'FS_STR_0000000001859'
           AND C.AREACODE = #{areacode}
       GROUP BY
           2
       ORDER BY
           TYPE, RCVTIME
    </select>

    <!-- 시장별 주간 데이터 추이 -->
    <select id="LIST_MCM_2WEEKS_AREA_DATA_CHART" parameterType="map" resultType="map">
        <![CDATA[
        SELECT
            (CASE
                 WHEN S.SDATE <= CURDATE() - INTERVAL (DAYOFWEEK(CURDATE())) DAY THEN '1'
                 ELSE '2'
             END) AS TYPE
            , DATE_FORMAT(S.SDATE, '%Y-%m-%d') AS RCVTIME
            , DAYOFWEEK(S.SDATE) AS WEEK
            , S.SNSRKWHDAILY AS CNT
        FROM
            (SELECT
                 SDATE, AREACODE, SUM(SNSRKWHDAILY) AS SNSRKWHDAILY
             FROM
                 F_ELEC_SENSOR_STAT
             WHERE
                 GUCODE LIKE '30%'
                 AND STRCODE != 'FS_STR_0000000001859'
                 AND SDATE >= CURDATE() - INTERVAL DAYOFWEEK(CURDATE()) + 6 DAY
                 AND AREACODE = #{areacode}
             GROUP BY
                 AREACODE, SDATE

             UNION ALL

             SELECT
                 CURDATE() SDATE, AREACODE, SUM(USEKWH) AS SNSRKWHDAILY
             FROM
                 F_CRN_SNSR_KWH_TODAY_STAT
             WHERE
                 GUCODE LIKE '30%'
                 AND STRCODE != 'FS_STR_0000000001859'
                 AND AREACODE = #{areacode}
             GROUP BY
                 AREACODE
            ) S
        ORDER BY
            S.SDATE
        ]]>
    </select>

    <!-- 시장별 주간 경보 발생 추이 -->
    <select id="LIST_MCM_2WEEKS_AREA_LOG_CHART" parameterType="map" resultType="map">
        <![CDATA[
        SELECT
            (CASE
                 WHEN SS.DATETIME <= CURDATE() - INTERVAL (DAYOFWEEK(CURDATE())) DAY THEN '1'
                 ELSE '2'
             END) AS TYPE
            , DATE_FORMAT(SS.DATETIME, '%Y-%m-%d') AS RCVTIME
            , DAYOFWEEK(SS.DATETIME) AS WEEK
            , SS.EVENTCNT AS CNT
        FROM
            (SELECT
                 AREACODE
                 , SDATE AS DATETIME
                 , SUM(TOTOCALM + TOTIGALM) AS EVENTCNT
              FROM
                  F_ELEC_SENSOR_STAT
              WHERE
                  GUCODE LIKE '30%'
                  AND STRCODE != 'FS_STR_0000000001859'
                  AND SDATE >= CURDATE() - INTERVAL DAYOFWEEK(CURDATE()) + 6 DAY
                  AND AREACODE = #{areacode}
              GROUP BY
                  AREACODE, SDATE

              UNION ALL

              SELECT
                  S.AREACODE
                  , CURDATE() AS DATETIME
                  , SUM(CASE WHEN L.OCALM + L.IGOALM + L.IGRALM > 0 THEN 1 ELSE 0 END)
              FROM
                  (SELECT SNSRID, OCALM, IGOALM, IGRALM FROM F_SENSOR_LOG WHERE REGDATE > CURDATE() AND ISSIMUL = 0) L
                      LEFT JOIN F_SENSOR_INFO I
                          ON L.SNSRID = I.SNSRID
                      LEFT JOIN F_STORE S
                          ON I.STRCODE = S.STRCODE
              WHERE
                  CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
                  AND S.STRCODE != 'FS_STR_0000000001859'
                  AND S.AREACODE = #{areacode}
             GROUP BY
                  S.AREACODE
            ) SS
        ORDER BY
            SS.DATETIME
        ]]>
    </select>

    <!-- 시장 지도 정보 -->
    <select id="LIST_MCM_AREA_MAP_SENSOR" parameterType="map" resultType="map">
        SELECT
            S.STRCODE
            , S.STRNAME
            , I.SNSRID
            , I.SNSRNICK
            , S.STRPOSLAT
            , S.STRPOSLON
            , (CASE
                   WHEN D.DANGERCNT > 0 THEN 'danger'
                   WHEN D.WARNCNT > 0 THEN 'warning'
                   WHEN D.DATACNT > 0 THEN 'normal'
                   ELSE 'discon'
               END) AS STATE
        FROM
            (SELECT STRCODE, SNSRID, SNSRNICK FROM F_SENSOR_INFO WHERE CONCAT(DELYN, STRCODE) LIKE 'NFS_STR_%') I
                LEFT JOIN F_STORE S
                    ON I.STRCODE = S.STRCODE
                LEFT JOIN (SELECT
                               D1.SNSRID
                               , SUM(CASE WHEN D1.SNSRRCVTIME > NOW() - INTERVAL 1 HOUR THEN 1 ELSE 0 END) AS DATACNT
                               , COALESCE(SUM(D2.ISDANGER), 0) AS DANGERCNT
                               , COALESCE(SUM(D2.ISWARN), 0) AS WARNCNT
                           FROM
                               (SELECT SNSRID, SNSRRCVTIME FROM F_SENSOR_DATA WHERE SNSRRCVTIME > CURDATE()) D1
                                   LEFT JOIN (SELECT
                                                  SNSRID
                                                  , REGDATE
                                                  , (CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN 1 ELSE 0 END) AS ISDANGER
                                                  , (CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN 1 ELSE 0 END) AS ISWARN
                                              FROM
                                                  F_SENSOR_LOG
                                              WHERE
                                                  REGDATE > CURDATE()
                                                  AND OCALM + IGOALM + IGRALM > 0
                                              ) D2
                                       ON D1.SNSRID = D2.SNSRID
                                       AND D1.SNSRRCVTIME = D2.REGDATE
                           GROUP BY
                               D1.SNSRID
                          ) D
                    ON I.SNSRID = D.SNSRID
        WHERE
            CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
            AND S.STRCODE != 'FS_STR_0000000001859'
        ORDER BY
            D.DANGERCNT DESC, D.WARNCNT DESC, D.DATACNT DESC, S.STRNAME
    </select>

    <!-- 상점 검색 목록 -->
    <select id="LIST_MCM_STORE_SEARCH" parameterType="map" resultType="map">
        SELECT
            S.AREACODE, L.AREANAME, S.STRCODE, S.STRNAME
        FROM
            (SELECT
                 AREACODE, STRCODE, STRNAME
             FROM
                 F_STORE
             WHERE
                 CONCAT(USEYN, DELYN, GRPCODE) = 'YN042'
                 AND STRCODE != 'FS_STR_0000000001859'
                 AND STRNAME LIKE CONCAT('%', #{search}, '%')
            ) S
                LEFT JOIN F_LEVEL_AREA L
                    ON S.AREACODE = L.AREACODE
        WHERE
            CONCAT(L.AREALEVEL, L.USEYN, L.DELYN, L.GUCODE) LIKE '1YN30%'
        ORDER BY
            S.STRNAME
    </select>

</mapper>
