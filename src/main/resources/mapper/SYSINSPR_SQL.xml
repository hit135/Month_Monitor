<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.fscom.firsens.sys.repository.SYSInsprRepo">

    <select id="LIST_SYS_INSPRAREA" resultType="map">
        SELECT
            AREACODE AS areaCode
            , AREANAME AS areaName
        FROM
            F_LEVEL_AREA
        WHERE
            AREALEVEL = 1
            AND USEYN = 'Y'
            AND DELYN = 'N'
        ORDER BY
            AREACODE
    </select>

    <select id="LIST_SYS_INSPECTORS" parameterType="map" resultType="map">
        SELECT
            T.*
        FROM
            (SELECT
                 ROW_NUMBER() over (ORDER BY Z.REGDATE) AS rowNo
                 , Z.*
             FROM
                 (SELECT
                      I.INSPID AS inspId
                      , I.INSPNAME As inspName
                      , I.INSPEMAIL AS inspEmail
                      , I.INSPTEL AS inspTel
                      , I.INSPMOBILE AS inspMobile
                      , I.INSPAREACODE AS inspAreaCode
                      , A.AREANAME AS inspAreaName
                      , I.INSPSHOPNAME AS inspShopName
                      , DATE_FORMAT(I.REGDATE, '%Y-%m-%d %H:%i:%s') AS regDate
                      , DATE_FORMAT(I.INSPRSNTDATE, '%Y-%m-%d %H:%i:%s') AS inspRsntDate
                  FROM
                      F_INSPECTOR I
                          LEFT JOIN
                            (SELECT
                                 AREACODE, AREANAME
                             FROM
                                 F_LEVEL_AREA
                             WHERE
                                 AREALEVEL = 1
                                 AND DELYN = 'N'
                            ) A
                                ON I.INSPAREACODE = A.AREACODE
                  WHERE
                      I.USEYN = #{useYn}
                      AND I.ALARMUSE = #{alarmUse}
                      <if test='loginLock == "Y"'>AND LOGINFAILCNT >= 5</if>
                      <if test='!@org.thymeleaf.util.StringUtils@isEmptyOrWhitespace(searchWrd)'>
                      AND (I.INSPID LIKE CONCAT('%', #{searchWrd}, '%')
                           OR I.INSPNAME LIKE CONCAT('%', #{searchWrd}, '%'))
                      </if>
                      <if test='!@org.thymeleaf.util.StringUtils@isEmptyOrWhitespace(inspAreaCode)'>
                      AND I.INSPAREACODE = #{inspAreaCode}
                      </if>
                  ORDER BY
                      I.REGDATE DESC) Z
            ) T
        ORDER BY
             T.rowNo DESC
        LIMIT
             #{page}, #{sizePerPage}
    </select>

    <select id="CNT_SYS_INSPECTORS" parameterType="map" resultType="int">
        SELECT
            COUNT(INSPID)
        FROM
            F_INSPECTOR
        WHERE
            USEYN = #{useYn}
            AND ALARMUSE = #{alarmUse}
            <if test='loginLock == "Y"'>AND LOGINFAILCNT >= 5</if>
            <if test='!@org.thymeleaf.util.StringUtils@isEmptyOrWhitespace(searchWrd)'>
            AND (INSPID LIKE CONCAT('%', #{searchWrd}, '%')
                 OR INSPNAME LIKE CONCAT('%', #{searchWrd}, '%'))
            </if>
            <if test='!@org.thymeleaf.util.StringUtils@isEmptyOrWhitespace(inspAreaCode)'>
            AND INSPAREACODE = #{inspAreaCode}
            </if>
    </select>

    <select id="CNT_SYS_DUPCHK_INSPID" parameterType="map" resultType="int">
        SELECT COUNT(INSPID) FROM F_INSPECTOR WHERE INSPID = #{inspId}
    </select>

    <insert id="INSERT_SYS_INSPECTOR" parameterType="map">
        INSERT INTO F_INSPECTOR (
               INSPID
             , INSPPASS
             , INSPNAME
             , INSPEMAIL
             , INSPTEL
             , INSPMOBILE
             , INSPAREACODE
             , INSPSHOPNAME
             , INSPADDR
             , ALARMUSE
             , PUSHUSE
             , SMSUSE
             , USEYN
             , REGDATE
             , UPDDATE
             , INSPRSNTDATE
             , LOGINFAILCNT
        ) VALUES (
               #{inspId}
             , #{inspPass}
             , #{inspName}
             , #{inspEmail}
             , #{inspTel}
             , #{inspMobile}
             , #{inspAreaCode}
             , #{inspShopName}
             , #{inspAddr}
             , 'Y'
             , 'Y'
             , 'Y'
             , 'Y'
             , NOW()
             , NOW()
             , NOW()
             , 0
        )
    </insert>

    <select id="SELECT_SYS_INSPECTOR" parameterType="string" resultType="map">
        SELECT
            I.INSPID AS inspId
            , I.INSPNAME As inspName
            , I.INSPEMAIL AS inspEmail
            , I.INSPTEL AS inspTel
            , I.INSPMOBILE AS inspMobile
            , I.INSPAREACODE AS inspAreaCode
            , A.AREANAME AS inspAreaName
            , I.INSPSHOPNAME AS inspShopName
            , DATE_FORMAT(I.REGDATE, '%Y-%m-%d %H:%i:%s') AS regDate
            , DATE_FORMAT(I.UPDDATE, '%Y-%m-%d %H:%i:%s') AS updDate
            , DATE_FORMAT(I.INSPRSNTDATE, '%Y-%m-%d %H:%i:%s') AS inspRsntDate
            , I.ALARMUSE AS alarmUse
            , I.PUSHUSE AS pushUse
            , I.SMSUSE AS smsUse
            , I.USEYN AS useYn
        FROM
            F_INSPECTOR I
                LEFT JOIN
                    (SELECT
                         AREACODE, AREANAME
                     FROM
                         F_LEVEL_AREA
                     WHERE
                        AREALEVEL = 1
                        AND DELYN = 'N'
                    ) A
                        ON I.INSPAREACODE = A.AREACODE
        WHERE
            I.INSPID = #{param}
    </select>

    <update id="UPDATE_SYS_INSPECTOR" parameterType="map">
        UPDATE
            F_INSPECTOR
        SET
            INSPNAME = #{inspName}
            , INSPEMAIL = #{inspEmail}
            , INSPTEL = #{inspTel}
            , INSPMOBILE = #{inspMobile}
            , INSPAREACODE = #{inspAreaCode}
            , INSPSHOPNAME = #{inspShopName}
            , UPDDATE = NOW()
            , ALARMUSE = #{alarmUse}
            , PUSHUSE = #{pushUse}
            , SMSUSE = #{smsUse}
            , USEYN = #{useYn}
            <if test="!@org.thymeleaf.util.StringUtils@isEmptyOrWhitespace(inspPass)">
            , INSPPASS = #{inspPass}
            </if>
        WHERE
            INSPID = #{inspId}
    </update>

</mapper>
