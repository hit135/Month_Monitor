<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.fscom.firsens.sys.repository.SYSAreaRepo">

    <select id="SELECT_LIST_SYS_AREA" parameterType="SYSAreaDomain" resultType="SYSAreaDomain">
        SELECT
            A.AREACODE AS 'key'
            , A.AREACODE AS areaCode
            , A.UPAREACODE AS upAreaCode
            , CONCAT(
                 A.AREANAME
                 , ' ('
                 , IFNULL(
                     CASE
                         WHEN A.AREALEVEL = 1
                         THEN (SELECT
                                   COUNT(AREACODE) AS STORECNT
                               FROM
                                   F_STORE
                               WHERE
                                   A.AREACODE = AREACODE
                               GROUP BY
                                   AREACODE)
                         WHEN A.AREALEVEL = 2
                         THEN (SELECT
                                   COUNT(LEVELAREACODE) AS STORECNT
                               FROM
                                   F_STORE
                               WHERE
                                   A.UPAREACODE = AREACODE
                                   AND A.AREACODE = LEVELAREACODE
                               GROUP BY
                                   AREACODE)
                     END
                   , 0)
                 , ')'
              ) AS title
            , A.AREALEVEL AS areaLevel
            , IFNULL(
                (SELECT
                     COUNT(AREACODE) AS STORECNT
                 FROM
                     F_STORE
                 WHERE
                     A.AREACODE = AREACODE
                 GROUP BY
                     AREACODE)
              , 0) AS storeCnt
        FROM
            F_LEVEL_AREA A
        WHERE
            1 = 1
            <!-- AND USEYN = 'Y' -->
        ORDER BY
            AREALEVEL, AREAORDER
    </select>

    <insert id="INSERT_SYS_LEVEL_AREA_ITEM" parameterType="SYSAreaDomain">
        INSERT INTO F_LEVEL_AREA (
               AREACODE
             , UPAREACODE
             , AREANAME
             , USEYN
             , AREAORDER
             , AREALEVEL
             , REGDATE
        ) VALUES (
               CONCAT(
                'AREA_'
               , LPAD(IFNULL((SELECT MAX(SEQ) FROM F_LEVEL_AREA FA), 0) + 1, '6', '0')
               )
             , #{upAreaCode}
             , 'temp'
             , 'Y'
             , (SELECT
                    IFNULL(MAX(FA.AREAORDER), 0) + 1
                FROM
                    F_LEVEL_AREA FA
                WHERE
                    UPAREACODE = #{upAreaCode})
             , #{areaLevel}
             , NOW()
        );
    </insert>

    <update id="UPDATE_SYS_LEVEL_AREA_ITEM" parameterType="SYSAreaDomain">
        UPDATE
            F_LEVEL_AREA
        SET
            AREACODE = #{areaCode}
            , AREANAME = #{areaName}
            , USERID = #{userId}
            , USEYN = #{useYn}
            , AREAORDER = #{areaOrder}
            , AREAMANAGER = #{areaManager}
            , AREAADDR = #{areaAddr}
            , AREAPOSLAT = #{areaPosLat}
            , AREAPOSLON = #{areaPosLon}
            , UPDATEDATE = NOW()
        WHERE
            AREACODE = #{areaCode}
    </update>

    <select id="CHECK_SYS_AREA_CODE" parameterType="String" resultType="int">
        SELECT
            IFNULL(COUNT(AREACODE), 0) AS cnt
        FROM
            F_LEVEL_AREA
        WHERE
            AREACODE = #{areaCode}
    </select>

    <select id="SELECT_ONE_SYS_AREA_ITEM" parameterType="String" resultType="SYSAreaDomain">
        SELECT
            DISTINCT FA.AREANAME AS areaName
            , FA.AREACODE AS areaCode
            , FA.UPAREACODE AS upAreaCode
            , FA.USEYN AS useYn
            , FA.DELYN AS delYn
            , DATE_FORMAT(FA.REGDATE, '%Y-%m-%d %H:%i:%s')     AS regDate
            , FA.AREAORDER AS areaOrder
            , FA.AREAADDR AS areaAddr
            , FA.AREAPOSLAT AS areaPosLat
            , FA.AREAPOSLON AS areaPosLon
            , FA.AREAMANAGER AS areaManager
            , FA.AREATEL AS areaTel
            , FA.GUCODE AS guCode
            , IFNULL(
                (SELECT
                     COUNT(AREACODE)
                 FROM
                     F_LEVEL_AREA B
                 WHERE
                     B.UPAREACODE = FA.UPAREACODE)
              , 0) AS orderCnt
        FROM
            F_LEVEL_AREA FA
        WHERE
            1 = 1
            AND FA.AREACODE = #{areaCode}
    </select>

    <delete id="DELETE_SYS_LEVEL_AREA_ITEM" parameterType="SYSAreaDomain">
        DELETE FROM F_LEVEL_AREA WHERE AREACODE = #{areaCode}
    </delete>

    <update id="UPDATE_SYS_AREA_ORDER" parameterType="SYSAreaDomain">
        UPDATE
            F_LEVEL_AREA A JOIN (SELECT @rank := 0) r
        SET
            A.AREAORDER = @rank:= (@rank+1)
        WHERE
            A.UPAREACODE = #{upAreaCode}
            <if test="!areaOrderType">ORDER BY A.AREAORDER, UPDATEDATE DESC</if>
            <if test="areaOrderType">ORDER BY A.AREAORDER</if>
    </update>

</mapper>
