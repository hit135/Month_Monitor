<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.fscom.firsens.mng.challenge.repository.MCDistrictRepo">

    <select id="SELECT_MCD_YESTERDAY_EVENT_COMP_STAT" parameterType="map" resultType="map">
        <![CDATA[
        SELECT
            I.SNSRCNT - A.ERRCNT AS YSNSRCNT
            , A.DANGERCNT AS YDANGERCNT
            , A.WARNINGCNT AS YWARNINGCNT
            , I.SNSRCNT - B.ERRCNT AS TSNSRCNT
            , B.DANGERCNT AS TDANGERCNT
            , B.WARNINGCNT AS TWARNINGCNT
        FROM
            (SELECT
                 COUNT(DISTINCT CASE WHEN (OCALM + IGOALM + IGRALM) > 0 THEN SNSRSEQ END) AS ERRCNT
                 , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN SNSRSEQ END) AS DANGERCNT
                 , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN SNSRSEQ END) AS WARNINGCNT
             FROM
                 V_ALL_SENSOR_LOG_MAP
             WHERE
                 CONCAT(GRPCODE, GUCODE) LIKE '04230%'
                 AND REGDATE > CURDATE() - INTERVAL 1 DAY
                 AND REGDATE < CURDATE()
            ) A
            ,
            (SELECT
                 COUNT(DISTINCT CASE WHEN (OCALM + IGOALM + IGRALM) > 0 THEN SNSRSEQ END) AS ERRCNT
                 , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN SNSRSEQ END) AS DANGERCNT
                 , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN SNSRSEQ END) AS WARNINGCNT
             FROM
                 V_ALL_SENSOR_LOG_MAP
             WHERE
                 CONCAT(GRPCODE, GUCODE) LIKE '04230%'
                 AND REGDATE > CURDATE()
            ) B
            ,
            (SELECT COUNT(*) AS SNSRCNT FROM V_ALL_SENSOR_MAP WHERE CONCAT(GRPCODE, GUCODE) LIKE '04230%') I
        ]]>
    </select>

    <select id="SELECT_MCD_TODAY_EVENT_STAT" parameterType="map" resultType="map">
        SELECT
            V.STRCNT
            , V.SNSRCNT
            , L.DANGERCNT
            , L.WARNINGCNT
            , L.DISCONNCNT
        FROM
            (SELECT
                 COUNT(DISTINCT STRCODE) AS STRCNT
                 , COUNT(DISTINCT SNSRSEQ) AS SNSRCNT
             FROM
                 V_ALL_SENSOR_MAP
             WHERE
                 CONCAT(GRPCODE, GUCODE) LIKE '04230%'
            ) V
            ,
            (SELECT
                 COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN SNSRSEQ END) AS DANGERCNT
                 , COUNT(DISTINCT
                             CASE
                                 WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') = 0 AND INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0
                                 THEN SNSRSEQ
                             END) AS WARNINGCNT
                 , COUNT(DISTINCT
                             CASE
                                 WHEN CONCAT(OCALM, IGOALM, IGRALM) = '000' AND DISCONN = 1
                                 THEN SNSRSEQ
                             END) AS DISCONNCNT
             FROM
                 V_ALL_SENSOR_LOG_MAP
             WHERE
                 CONCAT(GRPCODE, GUCODE) LIKE '04230%'
                 AND REGDATE > CURDATE()
            ) L
    </select>

    <select id="LIST_MCD_CURR_GU_MAP_EVENT_STAT" parameterType="map" resultType="map">
        <![CDATA[
        SELECT
            I.GUCODE
            , I.SNSRCNT
            , I.DISCONNCNT AS DISCONNCNT
            , COALESCE(L.DANGERCNT, 0) AS DANGERCNT
            , COALESCE(L.WARNINGCNT, 0) AS WARNINGCNT
        FROM
            (SELECT
                 GUCODE
                 , COUNT(DISTINCT SNSRSEQ) AS SNSRCNT
                 , COUNT(DISTINCT CASE WHEN DATARCVTIME < NOW() - INTERVAL 1 HOUR THEN SNSRSEQ END) AS DISCONNCNT
             FROM
                 V_ALL_SENSOR_MAP
             WHERE
                 CONCAT(GRPCODE, GUCODE) LIKE '04230%'
             GROUP BY
                 GUCODE
            ) I
                LEFT JOIN
                    (SELECT
                         GUCODE
                         , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN SNSRSEQ END) AS DANGERCNT
                         , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN SNSRSEQ END) AS WARNINGCNT
                     FROM
                         V_ALL_SENSOR_LOG_MAP
                     WHERE
                         CONCAT(GRPCODE, GUCODE) LIKE '04230%'
                         AND REGDATE > CURDATE()
                     GROUP BY
                         GUCODE
                    ) L
                        ON I.GUCODE = L.GUCODE
        ]]>
    </select>

    <select id="LIST_MCD_MONTHLY_GU_EVENT_COMP_STAT" parameterType="map" resultType="map">
        <![CDATA[
        SELECT
            L.GUCODE
            , COALESCE(A.EVENTCNT, 0) AS THATEVENTCNT
            , COALESCE(B.EVENTCNT, 0) AS THISEVENTCNT
        FROM
            (SELECT
                 DISTINCT GUCODE
             FROM
                 F_GUCODE
             WHERE
                 CONCAT(USEYN, GRPCODE, GUCODE) LIKE 'Y04230%'
                 AND GUCODE != '30200'
            ) L
                LEFT JOIN
                    (SELECT
                         GUCODE
                         , COALESCE(SUM(TOTOCALM) + SUM(TOTIGALM), 0) AS EVENTCNT
                     FROM
                         F_CRN_AREA_ELEC_DAILY_STAT
                     WHERE
                         GUCODE LIKE '30%'
                         AND SDATE > DATE_FORMAT(CURDATE() - INTERVAL 1 MONTH, '%Y-%m')
                         AND SDATE < DATE_FORMAT(CURDATE(), '%Y-%m')
                         AND GUCODE != '30200'
                     GROUP BY
                         GUCODE
                    ) A
                        ON L.GUCODE = A.GUCODE
                LEFT JOIN
                    (SELECT
                         SS.GUCODE
                         , COALESCE(SUM(SS.EVENTCNT), 0) AS EVENTCNT
                     FROM
                        (SELECT
                             GUCODE
                             , COALESCE(SUM(TOTOCALM) + SUM(TOTIGALM), 0) AS EVENTCNT
                         FROM
                             F_CRN_AREA_ELEC_DAILY_STAT
                         WHERE
                             GUCODE LIKE '30%'
                             AND SDATE > DATE_FORMAT(CURDATE(), '%Y-%m')
                             AND GUCODE != '30200'
                         GROUP BY
                             GUCODE

                         UNION ALL

                         SELECT
                             GUCODE
                             , COUNT(DISTINCT CASE WHEN (OCALM + IGRALM + IGOALM) > 0 THEN LSEQ END) AS EVENTCNT
                         FROM
                             V_ALL_SENSOR_LOG_MAP
                         WHERE
                             CONCAT(GRPCODE, GUCODE) LIKE '04230%'
                             AND REGDATE > CURDATE()
                         GROUP BY
                             GUCODE) SS
                     GROUP BY SS.GUCODE
                    ) B
                        ON A.GUCODE = B.GUCODE
        ORDER BY
            L.GUCODE
        ]]>
    </select>

    <select id="LIST_MCD_TODAY_GU_AREA_EVENT_COMP_RANK" parameterType="map" resultType="map">
        <![CDATA[
        SELECT
            R1.GUCODE
            , R1.GUNAME
            , R1.AREACODE
            , R1.AREANAME
            , COALESCE(R1.DANGERCNT, 0) AS THISDANGERCNT
            , COALESCE(R1.WARNINGCNT, 0) AS THISWARNINGCNT
            , RANK() OVER (ORDER BY (COALESCE(R1.DANGERCNT, 0) + COALESCE(R1.WARNINGCNT, 0)) DESC) AS 'RANK'
            , COALESCE(R2.DANGERCNT, 0) AS THATDANGERCNT
            , COALESCE(R2.WARNINGCNT, 0) AS THATWARNINGCNT
        FROM
            (SELECT
                 GUCODE
                 , GUNAME
                 , AREACODE
                 , AREANAME
                 , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN LSEQ END) AS DANGERCNT
                 , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN LSEQ END) AS WARNINGCNT
             FROM
                 V_ALL_SENSOR_LOG_MAP
             WHERE
                 CONCAT(GRPCODE, GUCODE) LIKE '04230%'
                 AND AREACODE != 'AREA_000001'
                 AND REGDATE > CURDATE()
             GROUP BY
                 AREACODE
            ) R1
                LEFT JOIN (SELECT
                               AREACODE
                               , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN LSEQ END) AS DANGERCNT
                               , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN LSEQ END) AS WARNINGCNT
                           FROM
                               V_ALL_SENSOR_LOG_MAP
                           WHERE
                               CONCAT(GRPCODE, GUCODE) LIKE '04230%'
                               AND REGDATE > CURDATE() - INTERVAL 1 DAY
                               AND REGDATE < CURDATE()
                               AND AREACODE != 'AREA_000001'
                           GROUP BY
                               AREACODE
                          ) R2
                    ON R1.AREACODE = R2.AREACODE
        ]]>
    </select>

    <select id="LIST_MCD_TODAY_GU_EVENT" parameterType="map" resultType="map">
        <![CDATA[
        SELECT
            R1.GUCODE
            , R1.GUNAME
            , COALESCE(R1.DANGERCNT, 0) AS THISDANGERCNT
            , COALESCE(R1.WARNINGCNT, 0) AS THISWARNINGCNT
            , COALESCE(R2.DANGERCNT, 0) AS THATDANGERCNT
            , COALESCE(R2.WARNINGCNT, 0) AS THATWARNINGCNT
        FROM
            (SELECT
                 GUCODE
                 , GUNAME
                 , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN LSEQ END) AS DANGERCNT
                 , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN LSEQ END) AS WARNINGCNT
             FROM
                  V_ALL_SENSOR_LOG_MAP
             WHERE
                  CONCAT(GRPCODE, GUCODE) LIKE '04230%'
                  AND REGDATE > CURDATE()
                  AND AREACODE != 'AREA_000001'
             GROUP BY
                  GUCODE
            ) R1
                LEFT JOIN (SELECT
                               GUCODE
                               , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN LSEQ END) AS DANGERCNT
                               , COUNT(DISTINCT CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN LSEQ END) AS WARNINGCNT
                           FROM
                               V_ALL_SENSOR_LOG_MAP
                           WHERE
                               CONCAT(GRPCODE, GUCODE) LIKE '04230%'
                               AND REGDATE > CURDATE() - INTERVAL 1 DAY
                               AND REGDATE < CURDATE()
                               AND AREACODE != 'AREA_000001'
                           GROUP BY
                               GUCODE
                          ) R2
                    ON R1.GUCODE = R2.GUCODE
        ]]>
    </select>
    <!-- ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->

    <select id="SELECT_MCD_KWH_STAT" parameterType="map" resultType="map">
        <![CDATA[
        SELECT
            A.USEKWH AS YESTERDAYUSEKWH
            , B.USEKWH AS LASTWEEKUSEKWH
            , C.USEKWH AS LASTMONTHUSEKWH
        FROM
            (SELECT
                 SUM(SNSRKWHDAILY) AS USEKWH
             FROM
                 F_CRN_AREA_ELEC_DAILY_STAT
             WHERE
                 GUCODE LIKE '30%'
                 AND SDATE = CURDATE() - INTERVAL 1 DAY) A
            ,
            (SELECT
                 SUM(SNSRKWHDAILY) AS USEKWH
             FROM
                 F_CRN_AREA_ELEC_DAILY_STAT
             WHERE
                 GUCODE LIKE '30%'
                 AND SDATE BETWEEN CURDATE() - INTERVAL WEEKDAY(CURDATE()) + 8 DAY
                           AND CURDATE() - INTERVAL WEEKDAY(CURDATE()) + 2 DAY
            ) B
            ,
            (SELECT
                 SUM(SNSRKWHDAILY) AS USEKWH
             FROM
                 F_CRN_AREA_ELEC_DAILY_STAT
             WHERE
                 GUCODE LIKE '30%'
                 AND SDATE > DATE_FORMAT(CURDATE() - INTERVAL 1 MONTH, '%Y-%m')
                 AND SDATE < DATE_FORMAT(CURDATE(), '%Y-%m')
            ) C
        ]]>
    </select>

    <select id="SELECT_MCD_CURR_KWH_STAT" parameterType="map" resultType="map">
        SELECT
            V.STRCNT
            , V.SNSRCNT
            , A.USEKWH AS YESTERDAYUSEKWH
            , B.USEKWH AS TODAYUSEKWH
            , (B.USEKWH / A.USEKWH) * 100 AS USEPER
        FROM
            (SELECT
                 COUNT(DISTINCT STRCODE) AS STRCNT
                 ,  COUNT(DISTINCT SNSRSEQ) AS SNSRCNT
             FROM
                 V_ALL_SENSOR_MAP
             WHERE
                 CONCAT(GRPCODE, GUCODE) LIKE '04230%'
            ) V
            ,
            (SELECT
                 SUM(SNSRKWHDAILY) AS USEKWH
             FROM
                 F_CRN_AREA_ELEC_DAILY_STAT
             WHERE
                 GUCODE LIKE '30%'
                 AND SDATE = CURDATE() - INTERVAL 1 DAY
            ) A
            ,
            (SELECT
                 SUM(USEKWH) AS USEKWH
             FROM
                 F_CRN_AREA_KWH_TODAY_STAT
             WHERE
                 GUCODE LIKE '30%'
            ) B
    </select>

    <select id="LIST_MCD_GU_MAP_KWH_STAT" parameterType="map" resultType="map">
        SELECT
            L.GUCODE
            , COALESCE(A.USEKWH, 0) AS THATWEEKUSEKWH
            , COALESCE(B.USEKWH, 0) AS THISWEEKUSEKWH
        FROM
            (SELECT
                 DISTINCT GUCODE
             FROM
                 F_GUCODE
             WHERE
                 CONCAT(USEYN, GRPCODE, GUCODE) LIKE 'Y04230%'
            ) L
                LEFT JOIN
                    (SELECT
                         GUCODE, SUM(SNSRKWHDAILY) AS USEKWH
                     FROM
                         F_CRN_AREA_ELEC_DAILY_STAT
                     WHERE
                         GUCODE LIKE '30%'
                         AND SDATE BETWEEN CURDATE() - INTERVAL WEEKDAY(CURDATE()) + 8 DAY
                                   AND CURDATE() - INTERVAL WEEKDAY(CURDATE()) + 2 DAY
                     GROUP BY
                         GUCODE
                    ) A
                        ON L.GUCODE = A.GUCODE
                LEFT JOIN
                    (SELECT
                         SS.GUCODE, COALESCE(SUM(USEKWH), 0) AS USEKWH
                     FROM
                         (SELECT
                              GUCODE, SUM(SNSRKWHDAILY) AS USEKWH
                          FROM
                              F_CRN_AREA_ELEC_DAILY_STAT
                          WHERE
                              GUCODE LIKE '30%'
                              AND SDATE >= CURDATE() - INTERVAL WEEKDAY(CURDATE()) + 1 DAY
                          GROUP BY
                              GUCODE

                          UNION ALL

                          SELECT
                              GUCODE, SUM(USEKWH) AS USEKWH
                          FROM
                              F_CRN_AREA_KWH_TODAY_STAT
                          WHERE
                              GUCODE LIKE '30%'
                              AND DATETIME > CURDATE()
                          GROUP BY
                              GUCODE) SS
                     GROUP BY
                         SS.GUCODE
                    ) B
                        ON L.GUCODE = B.GUCODE
        ORDER BY
            L.GUCODE
    </select>

    <select id="LIST_MCD_GU_MONTH_KWH_STAT" parameterType="map" resultType="map">
        <![CDATA[
        SELECT
            DISTINCT L.GUCODE
            , A.USEKWH AS THATMONTHUSEKWH
            , B.USEKWH AS THISMONTHUSEKWH
            , (B.USEKWH / A.USEKWH) * 100 AS USEPER
        FROM
            (SELECT
                 DISTINCT GUCODE, AREACODE
             FROM
                 F_LEVEL_AREA
             WHERE
                 CONCAT(AREALEVEL, DELYN, GUCODE) LIKE '1N30%'
                 AND GUCODE != '30200'
            ) L
                LEFT JOIN
                    (SELECT
                         GUCODE, SUM(SNSRKWHDAILY) AS USEKWH
                     FROM
                         F_CRN_AREA_ELEC_DAILY_STAT
                     WHERE
                         GUCODE LIKE '30%'
                         AND SDATE > DATE_FORMAT(CURDATE() - INTERVAL 1 MONTH, '%Y-%m')
                         AND SDATE < DATE_FORMAT(CURDATE(), '%Y-%m')
                         AND GUCODE != '30200'
                     GROUP BY
                         GUCODE
                    ) A
                        ON L.GUCODE = A.GUCODE
                LEFT JOIN
                    (SELECT
                         SS.GUCODE, COALESCE(SUM(SS.USEKWH), 0) AS USEKWH
                     FROM
                         (SELECT
                              GUCODE, SUM(SNSRKWHDAILY) AS USEKWH
                          FROM
                              F_CRN_AREA_ELEC_DAILY_STAT
                          WHERE
                              GUCODE LIKE '30%'
                              AND SDATE > DATE_FORMAT(CURDATE(), '%Y-%m')
                              AND GUCODE != '30200'
                          GROUP BY
                              GUCODE

                          UNION ALL

                          SELECT
                              GUCODE, SUM(USEKWH) AS USEKWH
                          FROM
                              F_CRN_AREA_KWH_TODAY_STAT
                          WHERE
                              GUCODE LIKE '30%'
                              AND DATETIME > CURDATE()
                              AND GUCODE != '30200'
                          GROUP BY
                              GUCODE) SS
                     GROUP BY SS.GUCODE
                    ) B
                        ON L.GUCODE = B.GUCODE
        ORDER BY
            L.GUCODE
        ]]>
    </select>

    <select id="LIST_MCD_GU_AREA_KWH_STAT" parameterType="map" resultType="map">
        <![CDATA[
        SELECT
            A.GUCODE
            , A.GUNAME
            , A.AREACODE
            , A.AREANAME
            , A.USEKWH AS THATMONTHUSEKWH
            , COALESCE(B.USEKWH, 0) AS THISMONTHUSEKWH
            , (CASE
                   WHEN A.USEKWH = 0 AND COALESCE(B.USEKWH, 0) != 0 THEN 100
                   WHEN COALESCE(B.USEKWH, 0) = 0 THEN 0
                   ELSE (COALESCE(B.USEKWH, 0) / A.USEKWH) * 100
              END) AS USEPER
        FROM
            (SELECT
                 L.GUCODE
                 , L.GUNAME
                 , L.AREACODE
                 , L.AREANAME
                 , COALESCE(R.USEKWH, 0) AS USEKWH
             FROM
                 (SELECT
                      DISTINCT GUCODE, GUNAME, AREACODE, AREANAME
                  FROM
                      V_ALL_SENSOR_MAP
                  WHERE
                      CONCAT(GRPCODE, GUCODE) LIKE '04230%'
                      AND AREACODE != 'AREA_000001'
                 ) L
                    LEFT JOIN
                        (SELECT
                              AREACODE
                              , SUM(SNSRKWHDAILY) AS USEKWH
                         FROM
                              F_CRN_AREA_ELEC_DAILY_STAT SS
                         WHERE
                              GUCODE LIKE '30%'
                              AND SDATE > DATE_FORMAT(CURDATE() - INTERVAL 1 MONTH, '%Y-%m')
                              AND SDATE < DATE_FORMAT(CURDATE(), '%Y-%m')
                              AND AREACODE != 'AREA_000001'
                         GROUP BY
                              AREACODE
                        ) R
                            ON L.AREACODE = R.AREACODE
            ) A
                LEFT JOIN
                    (SELECT
                         SS.AREACODE
                         , COALESCE(SUM(SS.USEKWH), 0) AS USEKWH
                     FROM
                         (SELECT
                              AREACODE
                              , SUM(SNSRKWHDAILY) AS USEKWH
                          FROM
                              F_CRN_AREA_ELEC_DAILY_STAT
                          WHERE
                              GUCODE LIKE '30%'
                              AND SDATE > DATE_FORMAT(CURDATE(), '%Y-%m')
                              AND AREACODE != 'AREA_000001'
                          GROUP BY
                              AREACODE

                          UNION ALL

                          SELECT
                              AREACODE, SUM(USEKWH) AS USEKWH
                          FROM
                              F_CRN_AREA_KWH_TODAY_STAT
                          WHERE
                              GUCODE LIKE '30%'
                              AND DATETIME > CURDATE()
                              AND AREACODE != 'AREA_000001'
                          GROUP BY
                              AREACODE) SS
                     GROUP BY
                         SS.AREACODE
                    ) B
                        ON A.AREACODE = B.AREACODE
        ORDER BY
            A.GUCODE, COALESCE(B.USEKWH, 0) DESC
        ]]>
    </select>

</mapper>
