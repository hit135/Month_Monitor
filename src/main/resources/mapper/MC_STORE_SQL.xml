<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.fscom.firsens.mng.challenge.repository.MCStoreRepo">

    <select id="LIST_MCST_STORE_INFO" parameterType="map" resultType="map">
        SELECT
            S.AREACODE, S.STRCODE, S.STRNAME, S.STRADDR, S.STRTEL, S.STROWNTEL, S.STRPOSLAT, S.STRPOSLON
        FROM
            F_STORE S
                LEFT JOIN F_SENSOR_INFO I
                    ON S.STRCODE = I.STRCODE
        WHERE
            CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
            AND S.STRCODE != 'FS_STR_0000000001859'
            AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
            AND I.SNSRID = #{snsrid}
    </select>

    <select id="LIST_MCST_SENSOR_EVT_CNT" parameterType="map" resultType="map">
        SELECT
            S.AREACODE
            , I.SNSRID
            , MAX(L.OCALM + L.IGOALM + L.IGRALM) AS ALMCNT
        FROM
            F_SENSOR_INFO I
                LEFT JOIN F_STORE S
                    ON I.STRCODE = S.STRCODE
                LEFT JOIN F_SENSOR_LOG L
                    ON A.SNSRID = L.SNSRID
        WHERE
            CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
            AND S.STRCODE != 'FS_STR_0000000001859'
            AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
            AND S.AREACODE = #{areacode}
            AND I.STRCODE = #{strcode}
        GROUP BY
            S.AREACODE, I.SNSRID
        ORDER BY
            3 DESC, I.SNSRID
    </select>
    <!-- ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->

    <select id="SELECT_MCST_STORE_INFO" parameterType="map" resultType="map">
        SELECT
            S.AREACODE
            , S.STRCODE
            , S.STRNAME
            , S.STRADDR
            , S.STRTEL
            , S.STROWNTEL
            , S.STRPOSLAT
            , S.STRPOSLON
            , GROUP_CONCAT(B.SEQ ORDER BY B.SEQ) AS SEQ
            , GROUP_CONCAT(B.STRCODE ORDER BY B.SEQ) AS STRCODE
            , GROUP_CONCAT(B.IMGNAME ORDER BY B.SEQ) AS IMGNAME
            , GROUP_CONCAT(B.IMGPATH ORDER BY B.SEQ) AS IMGPATH
            , GROUP_CONCAT(B.IMGSIZE ORDER BY B.SEQ) AS IMGSIZE
            , GROUP_CONCAT(B.IMGNUM ORDER BY B.SEQ) AS IMGNUM
            , GROUP_CONCAT(B.ORINAME ORDER BY B.SEQ) AS ORINAME
            , GROUP_CONCAT(DATE_FORMAT(B.REGDATE, '%Y-%m-%d %H:%i:%s') ORDER BY B.SEQ) AS REGDATE
        FROM
            F_STORE S
                LEFT JOIN (SELECT * FROM F_AREA_IMG WHERE IMGLEVEL = 'store') B
                    ON S.STRCODE = B.STRCODE
        WHERE
            CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
            AND S.STRCODE != 'FS_STR_0000000001859'
            AND S.AREACODE = #{areacode}
            AND S.STRCODE = #{strcode}
    </select>

    <select id="LIST_MCST_SENSOR_STATE" parameterType="map" resultType="map">
        <![CDATA[
        SELECT
            I.PANELNAME
            , I.SNSRID
            , I.SNSRNICK
            , S.STRPOSLAT
            , S.STRPOSLON
            , (CASE
                   WHEN L.DANGERCNT > 0 THEN 'WARNING'
                   WHEN L.WARNCNT > 0 THEN 'CAUTION'
                   WHEN I.DATARCVTIME < NOW() - INTERVAL 1 HOUR THEN 'DISCON'
                   ELSE 'NORMAL'
               END) AS STATE
        FROM
            F_SENSOR_INFO I
                LEFT JOIN F_STORE S
                    ON I.STRCODE = S.STRCODE
                LEFT JOIN (SELECT
                               SNSRSEQ
                               , SUM(CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '2') > 0 THEN 1 ELSE 0 END) AS DANGERCNT
                               , SUM(CASE WHEN INSTR(CONCAT(OCALM, IGOALM, IGRALM), '1') > 0 THEN 1 ELSE 0 END) AS WARNCNT
                           FROM
                               F_SENSOR_LOG
                           WHERE
                               REGDATE > CURDATE()
                           GROUP BY
                               SNSRSEQ
                          ) L
                    ON I.SNSRSEQ = L.SNSRSEQ
        WHERE
            CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
            AND S.STRCODE != 'FS_STR_0000000001859'
            AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
            AND S.AREACODE = #{areacode}
            AND S.STRCODE = #{strcode}
        ORDER BY
            4 DESC, I.PANELNAME, I.SNSRNICK
        ]]>
    </select>
    <!-- ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->

    <select id="SELECT_MCST_EVENT_TABLE_INFO" parameterType="map" resultType="map">
        SELECT
            A.BACKUPYEAR, MIN(A.MINDATE) AS MINDATE, MAX(A.MAXDATE) AS MAXDATE
        FROM
            (SELECT '' AS BACKUPYEAR, DATE(MIN(REGDATE)) AS MINDATE, DATE(MAX(REGDATE)) AS MAXDATE FROM F_SENSOR_LOG
             UNION
             SELECT '_2021' AS BACKUPYEAR, DATE(MIN(REGDATE)) AS MINDATE, DATE(MAX(REGDATE)) AS MAXDATE FROM F_SENSOR_LOG_2021
             UNION
             SELECT '_2020' AS BACKUPYEAR, DATE(MIN(REGDATE)) AS MINDATE, DATE(MAX(REGDATE)) AS MAXDATE FROM F_SENSOR_LOG_2020
            ) A
        WHERE
            #{regdt} BETWEEN A.MINDATE AND A.MAXDATE
    </select>

    <select id="LIST_MCST_STORE_SENSOR_DATA" parameterType="map" resultType="map">
        SELECT
            <choose>
                <when test='datatype == "m"'>STR_TO_DATE(DATE_FORMAT(D.SNSRRCVTIME, '%Y-%m'), '%Y-%m-%d')</when>
                <when test='datatype == "d"'>STR_TO_DATE(DATE(D.SNSRRCVTIME), '%Y-%m-%d')</when>
                <when test='datatype == "h"'>STR_TO_DATE(DATE_FORMAT(D.SNSRRCVTIME, '%Y-%m-%d %H'), '%Y-%m-%d %H')</when>
                <otherwise>D.SNSRRCVTIME</otherwise>
            </choose> AS REGDT
            , AVG(D.SNSRKWH) AS KWH
            , AVG(D.SNSRWATT) AS WATT
            , AVG(D.SNSRVOLT) AS VOLT
            , AVG(D.SNSRAMPERE) AS AMPERE
            , AVG(D.SNSRHZ) AS HZ
            , AVG(D.SNSRPF) AS PF
            , AVG(D.SNSRIGO) AS IGO
            , AVG(D.SNSRIGR) AS IGR
            , AVG(D.SNSRIGC) AS IGC
            , AVG(D.SNSRREG) AS REG
        FROM
            F_SENSOR_INFO I
                LEFT JOIN F_STORE S
                    ON I.STRCODE = S.STRCODE
                LEFT JOIN ${tblSensorData} D
                    ON I.SNSRID = D.SNSRID
        WHERE
            CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
            AND S.STRCODE != 'FS_STR_0000000001859'
            AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
            AND S.STRCODE = #{strcode}
            <if test="!@org.thymeleaf.util.StringUtils@isEmptyOrWhitespace(snsrid)">
            AND I.SNSRID = #{snsrid}
            </if>
            AND D.SNSRRCVTIME BETWEEN CONCAT(#{regdt}, ' 00:00:00') AND
                <choose>
                    <when test='termtype == "m"'>CONCAT(LAST_DAY(#{regdt}, ' 23:59:59'))</when>
                    <otherwise>CONCAT(#{regdt}, ' 23:59:59')</otherwise>
                </choose>
        GROUP BY
            1
        ORDER BY
            1 ${order}
    </select>

    <select id="LIST_MCST_DATA_LOG" parameterType="map" resultType="map">
        SELECT
            DISTINCT I.SNSRID
            , DATE_FORMAT(D.SNSRRCVTIME, '%Y-%m-%d %H:%i:%s') AS SNSRRCVTIME
            , DATE_FORMAT(D.SNSRRCVTIME, '%Y-%m-%d') AS REGDATE
            , D.SNSRKWH
            , D.SNSRVOLT
            , D.SNSRWATT
            , D.SNSRAMPERE
            , D.SNSRHZ
            , D.SNSRPF
            , D.SNSRREG
            , D.SNSRRSSI
            , D.SNSRIGR
            , D.SNSRIGO
            , D.SNSRIGC
            , L.OCALM
            , L.IGOALM
            , L.IGRALM
            , L.LCAUSE
            , (CASE
                   WHEN INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') > 0 THEN 'DANGER'
                   WHEN INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '1') > 0 THEN 'WARN'
               END) AS STATE
            , (CASE
                   WHEN OCALM > 0 THEN 'AMPERE'
                   WHEN IGOALM > 0 THEN 'IGO'
                   WHEN IGRALM > 0 THEN 'IGR'
               END) AS ALMTYPE
            , DATE_FORMAT(I.DATARCVTIME, '%Y-%m-%d %H:%i:%s') AS DATARCVTIME
        FROM
            ${tblSensorData} D
                LEFT JOIN ${tblSensorLog} L
                    ON D.SNSRID = L.SNSRID
                    AND D.SNSRRCVTIME = L.REGDATE
                LEFT JOIN F_SENSOR_INFO I
                    ON D.SNSRID = I.SNSRID
                LEFT JOIN F_STORE S
                    ON I.STRCODE = S.STRCODE
        WHERE
            CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
            AND S.STRCODE != 'FS_STR_0000000001859'
            AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
            AND D.SNSRRCVTIME
            <choose>
                <when test="!@org.thymeleaf.util.StringUtils@isEmptyOrWhitespace(regdt)">BETWEEN CONCAT(#{regdt}, ' 00:00:00') AND CONCAT(#{regdt}, ' 23:59:59')</when>
                <otherwise> > CURDATE()</otherwise>
            </choose>
            AND S.AREACODE = #{areacode}
            AND S.STRCODE = #{strcode}
            <if test="!@org.thymeleaf.util.StringUtils@isEmptyOrWhitespace(snsrid)">
            AND I.SNSRID = #{snsrid}
            </if>
        ORDER BY
            D.SNSRRCVTIME DESC
    </select>

    <select id="SELECT_MCST_SENSOR_USEKWH_MONTH" parameterType="map" resultType="float">
        SELECT
            IFNULL(MAX(SNSRKWH) - MIN(SNSRKWH), 0)
        FROM
            ${tblSensorData} D
                LEFT JOIN F_SENSOR_INFO I
                    ON D.SNSRSEQ = I.SNSRSEQ
                LEFT JOIN F_STORE S
                    ON I.STRCODE = S.STRCODE
        WHERE
            CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
            AND S.STRCODE != 'FS_STR_0000000001859'
            AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
            AND I.SNSRID = #{snsrid}
            AND D.SNSRRCVTIME BETWEEN CONCAT(DATE_FORMAT(#{regdt}, '%Y-%m'), '-01 00:00:00')
                              AND CONCAT(LAST_DAY(#{regdt}), ' 23:59:59')
    </select>
    <!-- ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->

    <select id="CNT_DATA_LOG_TOTAL" parameterType="map" resultType="int">
        <![CDATA[
        SELECT
            A.CNT + B.CNT + C.CNT
        FROM
            (SELECT
                 COUNT(D.SNSRRCVTIME) AS CNT
             FROM
                 F_SENSOR_DATA D
                     LEFT JOIN F_SENSOR_INFO I
                         ON D.SNSRID = I.SNSRID
                     LEFT JOIN F_STORE S
                         ON I.STRCODE = S.STRCODE
             WHERE
                 CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
                 AND S.STRCODE != 'FS_STR_0000000001859'
                 AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
                 AND D.SNSRRCVTIME <= CONCAT(#{regdt}, ' 23:59:59')
                 AND D.SNSRID = #{snsrid}
            ) A
            ,
            (SELECT
                 COUNT(D.SNSRRCVTIME) AS CNT
             FROM
                 F_SENSOR_DATA_2021 D
                    LEFT JOIN F_SENSOR_INFO I
                        ON D.SNSRID = I.SNSRID
                    LEFT JOIN F_STORE S
                        ON I.STRCODE = S.STRCODE
             WHERE
                 CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
                 AND S.STRCODE != 'FS_STR_0000000001859'
                 AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
                 AND D.SNSRRCVTIME <= CONCAT(#{regdt}, ' 23:59:59')
                 AND D.SNSRID = #{snsrid}
            ) B
            ,
            (SELECT
                 COUNT(D.SNSRRCVTIME) AS CNT
             FROM
                 F_SENSOR_DATA_2020 D
                     LEFT JOIN F_SENSOR_INFO I
                         ON D.SNSRID = I.SNSRID
                     LEFT JOIN F_STORE S
                         ON I.STRCODE = S.STRCODE
             WHERE
                 CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
                 AND S.STRCODE != 'FS_STR_0000000001859'
                 AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
                 AND D.SNSRRCVTIME <= CONCAT(#{regdt}, ' 23:59:59')
                 AND D.SNSRID = #{snsrid}
            ) B
        ]]>
    </select>

    <select id="LIST_MCST_DATA_LOG_TOTAL" parameterType="map" resultType="map">
        <![CDATA[
        (SELECT
             DATE_FORMAT(D.SNSRRCVTIME, '%Y-%m-%d %H:%i:%s') AS SNSRRCVTIME
             , D.SNSRID
             , SUBSTRING(D.SNSRID FROM 9 FOR 4) SNSRIDSUBSTR
             , D.SNSRWATT
             , D.SNSRAMPERE
             , D.SNSRIGO
         FROM
             F_SENSOR_DATA D
                 LEFT JOIN F_SENSOR_INFO I
                     ON D.SNSRID = I.SNSRID
                 LEFT JOIN F_STORE S
                     ON I.STRCODE = S.STRCODE
         WHERE
             CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
             AND S.STRCODE != 'FS_STR_0000000001859'
             AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
             AND D.SNSRRCVTIME <= CONCAT(#{regdt}, ' 23:59:59')
             AND D.SNSRID = #{snsrid}
         ORDER BY
             D.SNSRRCVTIME DESC
         LIMIT
             #{pagelimit})

        UNION ALL

        (SELECT
             DATE_FORMAT(D.SNSRRCVTIME, '%Y-%m-%d %H:%i:%s') AS SNSRRCVTIME
             , D.SNSRID
             , SUBSTRING(D.SNSRID FROM 9 FOR 4) SNSRIDSUBSTR
             , D.SNSRWATT
             , D.SNSRAMPERE
             , D.SNSRIGO
         FROM
             F_SENSOR_DATA_2021
                 LEFT JOIN F_SENSOR_INFO I
                     ON D.SNSRID = I.SNSRID
                 LEFT JOIN F_STORE S
                     ON I.STRCODE = S.STRCODE
         WHERE
             CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
             AND S.STRCODE != 'FS_STR_0000000001859'
             AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
             AND D.SNSRRCVTIME <= CONCAT(#{regdt}, ' 23:59:59')
             AND D.SNSRID = #{snsrid}
         ORDER BY
             D.SNSRRCVTIME DESC
         LIMIT
             #{pagelimit})
        LIMIT
            #{pagestart}, 1000
        ]]>
    </select>

    <select id="CNT_DATA_LOG_EVENT" parameterType="map" resultType="int">
        SELECT
            A.CNT + B.CNT + C.CNT
        FROM
            (SELECT
                 COUNT(L.REGDATE) AS CNT
             FROM
                 F_SENSOR_LOG L
                     LEFT JOIN F_SENSOR_INFO I
                         ON L.SNSRID = I.SNSRID
                     LEFT JOIN F_STORE S
                         ON I.STRCODE = S.STRCODE
             WHERE
                 CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
                 AND S.STRCODE != 'FS_STR_0000000001859'
                 AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
                 AND L.REGDATE <![CDATA[<=]]> CONCAT(#{regdt}, ' 23:59:59')
                 AND L.SNSRID = #{snsrid}
                 AND <choose>
                         <when test='"check-danger,check-warn".equals(type)'>(L.OCALM + L.IGOALM + L.IGRALM) > 0</when>
                         <when test='"check-danger".equals(type)'>INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') > 0</when>
                         <when test='"check-warn".equals(type)'>
                         (INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') = 0
                          AND INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '1') > 0)
                         </when>
                     </choose>
            ) A
            ,
            (SELECT
                 COUNT(L.REGDATE) AS CNT
             FROM
                 F_SENSOR_LOG_2021 L
                     LEFT JOIN F_SENSOR_INFO I
                         ON L.SNSRID = I.SNSRID
                     LEFT JOIN F_STORE S
                         ON I.STRCODE = S.STRCODE
             WHERE
                 CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
                 AND S.STRCODE != 'FS_STR_0000000001859'
                 AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
                 AND L.REGDATE <![CDATA[<=]]> CONCAT(#{regdt}, ' 23:59:59')
                 AND L.SNSRID = #{snsrid}
                 AND <choose>
                         <when test='"check-danger,check-warn".equals(type)'>(L.OCALM + L.IGOALM + L.IGRALM) > 0</when>
                         <when test='"check-danger".equals(type)'>INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') > 0</when>
                         <when test='"check-warn".equals(type)'>
                         (INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') = 0
                          AND INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '1') > 0)
                         </when>
                     </choose>
            ) B
            ,
            (SELECT
                 COUNT(L.REGDATE) AS CNT
             FROM
                 F_SENSOR_LOG_2020 L
                     LEFT JOIN F_SENSOR_INFO I
                         ON L.SNSRID = I.SNSRID
                     LEFT JOIN F_STORE S
                         ON I.STRCODE = S.STRCODE
             WHERE
                 CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
                 AND S.STRCODE != 'FS_STR_0000000001859'
                 AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
                 AND L.REGDATE <![CDATA[<=]]> CONCAT(#{regdt}, ' 23:59:59')
                 AND L.SNSRID = #{snsrid}
                 AND <choose>
                         <when test='"check-danger,check-warn".equals(type)'>(L.OCALM + L.IGOALM + L.IGRALM) > 0</when>
                         <when test='"check-danger".equals(type)'>INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') > 0</when>
                         <when test='"check-warn".equals(type)'>
                         (INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') = 0
                          AND INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '1') > 0)
                         </when>
                     </choose>
            ) C
    </select>

    <select id="LIST_MCST_DATA_LOG_EVENT" parameterType="map" resultType="map">
        (SELECT
             DATE_FORMAT(L.REGDATE, '%Y-%m-%d %H:%i:%s') AS SNSRRCVTIME
             , L.SNSRID
             , SUBSTRING(L.SNSRID FROM 9 FOR 4) SNSRIDSUBSTR
             , L.LCAUSE
             , (CASE
                    WHEN INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') > 0 THEN 'DANGER'
                    WHEN INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') = 0 AND INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '1') > 0 THEN 'WARN'
                END) AS STATE
         FROM
             F_SENSOR_LOG L
                 LEFT JOIN F_SENSOR_INFO I
                     ON L.SNSRID = I.SNSRID
                 LEFT JOIN F_STORE S
                     ON I.STRCODE = S.STRCODE
         WHERE
             CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
             AND S.STRCODE != 'FS_STR_0000000001859'
             AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
             AND L.REGDATE <![CDATA[<=]]> CONCAT(#{regdt}, ' 23:59:59')
             AND L.SNSRID = #{snsrid}
             AND <choose>
                     <when test='"check-danger,check-warn".equals(type)'>(L.OCALM + L.IGOALM + L.IGRALM) > 0</when>
                     <when test='"check-danger".equals(type)'>INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') > 0</when>
                     <when test='"check-warn".equals(type)'>
                     (INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') = 0
                      AND INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '1') > 0)
                     </when>
                 </choose>
         ORDER BY
             L.REGDATE DESC
         LIMIT
             #{pagelimit})

        UNION ALL

        (SELECT
             DATE_FORMAT(L.REGDATE, '%Y-%m-%d %H:%i:%s') AS SNSRRCVTIME
             , L.SNSRID
             , SUBSTRING(L.SNSRID FROM 9 FOR 4) SNSRIDSUBSTR
             , L.LCAUSE
             , (CASE
                    WHEN INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') > 0 THEN 'DANGER'
                    WHEN INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') = 0 AND INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '1') > 0 THEN 'WARN'
                END) AS STATE
         FROM
             F_SENSOR_LOG_2021 L
                 LEFT JOIN F_SENSOR_INFO I
                     ON L.SNSRID = I.SNSRID
                 LEFT JOIN F_STORE S
                     ON I.STRCODE = S.STRCODE
         WHERE
             CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
             AND S.STRCODE != 'FS_STR_0000000001859'
             AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
             AND L.REGDATE <![CDATA[<=]]> CONCAT(#{regdt}, ' 23:59:59')
             AND L.SNSRID = #{snsrid}
             AND <choose>
                     <when test='"check-danger,check-warn".equals(type)'>(L.OCALM + L.IGOALM + L.IGRALM) > 0</when>
                     <when test='"check-danger".equals(type)'>INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') > 0</when>
                     <when test='"check-warn".equals(type)'>
                     (INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') = 0
                      AND INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '1') > 0)
                     </when>
                 </choose>
         ORDER BY
             L.REGDATE DESC
         LIMIT
             #{pagelimit})

        UNION ALL

        (SELECT
             DATE_FORMAT(L.REGDATE, '%Y-%m-%d %H:%i:%s') AS SNSRRCVTIME
             , L.SNSRID
             , SUBSTRING(L.SNSRID FROM 9 FOR 4) SNSRIDSUBSTR
             , L.LCAUSE
             , (CASE
                    WHEN INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') > 0 THEN 'DANGER'
                    WHEN INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') = 0 AND INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '1') > 0 THEN 'WARN'
                END) AS STATE
         FROM
             F_SENSOR_LOG_2020 L
                 LEFT JOIN F_SENSOR_INFO I
                     ON L.SNSRID = I.SNSRID
                 LEFT JOIN F_STORE S
                     ON I.STRCODE = S.STRCODE
         WHERE
             CONCAT(S.USEYN, S.DELYN, S.GRPCODE) = 'YN042'
             AND S.STRCODE != 'FS_STR_0000000001859'
             AND CONCAT(I.DELYN, I.STRCODE) LIKE 'NFS_STR_%'
             AND L.REGDATE <![CDATA[<=]]> CONCAT(#{regdt}, ' 23:59:59')
             AND L.SNSRID = #{snsrid}
             AND <choose>
                     <when test='"check-danger,check-warn".equals(type)'>(L.OCALM + L.IGOALM + L.IGRALM) > 0</when>
                     <when test='"check-danger".equals(type)'>INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') > 0</when>
                     <when test='"check-warn".equals(type)'>
                     (INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '2') = 0
                      AND INSTR(CONCAT(L.OCALM, L.IGOALM, L.IGRALM), '1') > 0)
                     </when>
                 </choose>
         ORDER BY
             L.REGDATE DESC
         LIMIT
             #{pagelimit})
        LIMIT
            #{pagestart}, 1000
    </select>
    <!-- ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->

    <select id="LIST_MCST_LOG_3DAYS_STAT" parameterType="map" resultType="map">
        SELECT
            DATE_FORMAT(A.DATETIME, '%m-%d') AS DATETIME
            , COALESCE(B.DANGER, 0) AS DANGER
            , COALESCE(B.WARN, 0) AS WARN
        FROM
            (SELECT CURDATE() - INTERVAL seq DAY DATETIME FROM seq_0_to_2) A
                LEFT JOIN (SELECT
                               DATE(S.DATETIME) AS DATETIME
                               , SUM(S.DANGERCNT) AS DANGER
                               , SUM(S.WARNINGCNT) AS WARN
                           FROM
                               F_CRN_SNSR_ELEC_EVT_STAT S
                           WHERE
                               S.GUCODE LIKE '30%'
                               AND S.STRCODE != 'FS_STR_0000000001859'
                               AND S.AREACODE = #{areacode}
                               AND S.STRCODE = #{strcode}
                               AND S.SNSRSEQ = (SELECT SNSRSEQ FROM F_SENSOR_INFO WHERE SNSRID = #{snsrid})
                               AND S.DATETIME > CURDATE() - INTERVAL 2 DAY
                           GROUP BY
                               DATE(S.DATETIME)
                          ) B
                    ON A.DATETIME = B.DATETIME
        GROUP BY
            DATE(A.DATETIME)
        ORDER BY
            DATETIME
    </select>

    <select id="LIST_MCST_LOG_WEEK_STAT" parameterType="map" resultType="map">
        SELECT
            DATE_FORMAT(A.DATETIME, '%m-%d') AS DATETIME
            , COALESCE(B.DANGER, 0) AS DANGER
            , COALESCE(B.WARN, 0) AS WARN
        FROM
            (SELECT CURDATE() - INTERVAL seq DAY DATETIME FROM seq_0_to_6) A
                LEFT JOIN (SELECT
                               DATE(S.DATETIME) AS DATETIME
                               , SUM(S.DANGERCNT) AS DANGER
                               , SUM(S.WARNINGCNT) AS WARN
                           FROM
                               F_CRN_SNSR_ELEC_EVT_STAT S
                           WHERE
                               S.GUCODE LIKE '30%'
                               AND S.STRCODE != 'FS_STR_0000000001859'
                               AND S.AREACODE = #{areacode}
                               AND S.STRCODE = #{strcode}
                               AND S.SNSRSEQ = (SELECT SNSRSEQ FROM F_SENSOR_INFO WHERE SNSRID = #{snsrid})
                               AND S.DATETIME > CURDATE() - INTERVAL 6 DAY
                           GROUP BY
                               DATE(S.DATETIME)
                          ) B
                    ON A.DATETIME = B.DATETIME
        GROUP BY
            DATE(A.DATETIME)
        ORDER BY
            DATETIME
    </select>
    <!-- ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->

    <insert id="INSERT_MCST_SENSOR_CHECK" parameterType="map">
        INSERT INTO F_SENSOR_CHECK (CHECKSEQ, SNSRID, REGDATE, CHECKSTAT)
        VALUES (NULL, #{snsrid}, NOW(), 'ING')
    </insert>

    <update id="UPDATE_MCST_SENSOR_CHECK" parameterType="map">
        UPDATE
            F_SENSOR_CHECK
        SET
            PROCDATE  = NOW()
            , CHECKSTAT = 'END'
        WHERE
            SNSRID = #{snsrid}
            AND CHECKSTAT = 'ING'
    </update>

    <!--
    <select id="SELECT_MCST_LIST_MCST_STORE_SENSOR" parameterType="map" resultType="map">
        SELECT
            C.AREACODE, C.AREANAME, C2.AREACODE, C2.AREANAME, B.STRCODE, B.STRNAME
            , A.PANELNAME, A.SNSRID, A.SNSRSEQ, A.SNSRNICK, D.STATE, D.DATACNT, A.SVOL
            , A.SOC1V1, A.SOC1V2, A.SOC1T1, A.SOC1T2, A.SOC2V1, A.SOC2V2, A.SOC2T1, A.SOC2T2
            , A.SIGO1V, A.SIGO2V, A.SIGO1T, A.SIGO2T, A.SIGR1V, A.SIGR2V, A.SIGR1T, A.SIGR2T
        FROM
            F_SENSOR_INFO A
                LEFT JOIN
                    F_STORE B
                        ON A.AREACODE = B.AREACODE
                        AND A.STRCODE = B.STRCODE
                LEFT JOIN
                    F_LEVEL_AREA C
                        ON B.AREACODE = C.AREACODE
                LEFT JOIN
                    F_LEVEL_AREA C2
                        ON B.LEVELAREACODE = C2.AREACODE
                LEFT JOIN
                    (SELECT
                         SNSRID, MAX(DATACNT) AS DATACNT, MAX(STATE) AS STATE
                     FROM
                         (SELECT
                              SNSRID
                              , COUNT(*) AS DATACNT
                              , (CASE
                                     WHEN INSTR(CONCAT(MAX(OCALM), MAX(IGOALM), MAX(IGRALM)), '2') > 0 THEN '3'
                                     WHEN INSTR(CONCAT(MAX(OCALM), MAX(IGOALM), MAX(IGRALM)), '1') > 0 THEN '2'
                                END) AS STATE
                          FROM
                              F_SENSOR_LOG
                          WHERE
                              REGDATE > NOW() - INTERVAL 30 MINUTE
                          GROUP BY
                              SNSRID

                          UNION

                          SELECT
                              SNSRID
                              , COUNT(*) AS DATACNT
                              , (CASE WHEN COUNT(*) > 0 THEN '1' END) AS STATE
                          FROM
                              F_SENSOR_DATA
                          WHERE
                              SNSRRCVTIME > NOW() - INTERVAL 30 MINUTE
                          GROUP BY
                              SNSRID
                         ) A
                     GROUP BY
                         SNSRID
                     ORDER BY
                         2 DESC, SNSRID
                    ) D
                        ON A.SNSRID = D.SNSRID
        WHERE
            B.STRCODE = #{strcode}
            AND C.AREACODE = #{areacode}
        ORDER BY
            D.STATE DESC, D.DATACNT DESC, A.PANELNAME, B.STRNAME, A.SNSRNICK
    </select>
    -->

</mapper>