<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.fscom.firsens.sys.repository.SYSSnsrRepo">
    <select id="SELECT_CNT_SYS_SNSR" parameterType="SYSSnsrDomain" resultType="int">
        SELECT COUNT(*)
          FROM F_SENSOR_INFO SI
          LEFT JOIN F_STORE ST
                 ON ST.STRCODE = SI.STRCODE
                AND ST.AREACODE = SI.AREACODE
         WHERE SI.DELYN = 'N'
        <if test='areaCode != "all" and areaCode == levelAreaCode'>
            AND SI.AREACODE = #{areaCode}
        </if>
        <if test='areaCode != "all" and areaCode != levelAreaCode'>
            AND SI.LEVELAREACODE = #{levelAreaCode}
        </if>
        <if test='searchWrd != null and searchWrd !=""'>
           AND (    SI.SNSRID   LIKE CONCAT( '%', #{ searchWrd }, '%' )
           OR SI.SNSRNICK LIKE CONCAT( '%', #{ searchWrd }, '%' )
           OR ST.STRNAME LIKE CONCAT( '%', #{ searchWrd }, '%' )
           OR SI.SNSRSEQ  LIKE CONCAT( '%', #{ searchWrd }, '%' ) )
        </if>
    </select>

    <!-- 센서목록 조회 -->
    <select id="SELECT_LIST_SYS_SNSR" parameterType="SYSSnsrDomain" resultType="SYSSnsrDomain">
                SELECT Z.*
                  FROM ( SELECT @ROWNUM := @ROWNUM + 1                                      AS rownum
                              , A.*
                           FROM ( SELECT SI.SNSRSEQ                                         AS snsrSeq
                                       , SI.SNSRID                                          AS snsrId
                                       , SI.SNSRNICK                                        AS snsrNick
                                       , ST.STRNAME                                         AS strName
                                       , DATE_FORMAT( SI.REGDATE, '%Y-%m-%d %H:%i' )        AS regDate
                                       , DATE_FORMAT( SI.UPDDATE, '%Y-%m-%d %H:%i' )        AS updDate
                                       , SI.SNSRID                                          AS snsrIdKey
                                       , SI.SOC1V1                                          AS sOc1V1
                                       , SI.SOC2V1                                          AS sOc2V1
                                       , SI.SIGR1V                                          AS sIgr1V
                                       , SI.SIGR2V                                          AS sIgr2V
                                       , SI.SIGO1V                                          AS sIgo1V
                                       , SI.SIGO2V                                          AS sIgo2V
                                       , SI.CHANNEL                                         AS channel
                                       , SI.DELYN                                           AS delYn
                                    FROM F_SENSOR_INFO SI
                                    LEFT JOIN F_STORE ST
                                           ON ST.STRCODE = SI.STRCODE
                                          AND ST.AREACODE = SI.AREACODE
                                   WHERE SI.DELYN = 'N'
                                     <if test='areaCode != "all" and areaCode == levelAreaCode'>
                                         AND SI.AREACODE = #{areaCode}
                                     </if>
                                     <if test='areaCode != "all" and areaCode != levelAreaCode'>
                                         AND SI.LEVELAREACODE = #{levelAreaCode}
                                     </if>

                                     <if test='searchWrd != null and searchWrd !=""'>
                                        AND (    SI.SNSRID   LIKE CONCAT( '%', #{ searchWrd }, '%' )
                                              OR SI.SNSRNICK LIKE CONCAT( '%', #{ searchWrd }, '%' )
                                              OR ST.STRNAME LIKE CONCAT( '%', #{ searchWrd }, '%' )
                                              OR SI.SNSRSEQ  LIKE CONCAT( '%', #{ searchWrd }, '%' ) )
                                     </if>
                                   ORDER BY SI.SNSRID ) A,
                                ( SELECT @ROWNUM := 0 ) R
                          ORDER BY rownum desc
                       ) Z
                 LIMIT #{ page }, #{ sizePerPage }
    </select>

    <update id="GENERATE_SNSR_CODE" parameterType="SYSSnsrDomain">
        <selectKey keyProperty="generateKey" resultType="int" order="AFTER">
            SELECT NEXT_ID AS generateKey FROM COMTECOPSEQ WHERE TABLE_NAME = #{keyFied}
        </selectKey>
        UPDATE COMTECOPSEQ SET NEXT_ID = NEXT_ID + 1
        WHERE TABLE_NAME = #{keyFied}
    </update>

    <insert id="INSERT_SYS_SNSR" parameterType="SYSSnsrDomain">
         INSERT INTO F_SENSOR_INFO (
                    SNSRSEQ
                  , SNSRID
                  , STRCODE
                  , REGDATE
                  , SNSRNICK
                  , SNSRMGPS
                  , SVOL
                  , SOC1V1
                  , SOC1T1
                  , SOC1V2
                  , SOC1T2
                  , SOC2V1
                  , SOC2T1
                  , SOC2V2
                  , SOC2T2
                  , SIGO1V
                  , SIGO1T
                  , SIGO2V
                  , SIGO2T
                  , SIGR1V
                  , SIGR1T
                  , SIGR2V
                  , SIGR2T
                  , SSEC
                  , COMPTYPE
                  , CHANNEL
        ) VALUES (
                    CONCAT('FS_SNR_',LPAD( #{generateKey} ,'13','0'))
                  , #{snsrId}
                  , #{strCode}
                  , NOW()
                  , #{snsrNick}
                  , #{snsrMGps}
                  , #{sVol}
                  , #{sOc1V1}
                  , #{sOc1T1}
                  , #{sOc1V2}
                  , #{sOc1T2}
                  , #{sOc2V1}
                  , #{sOc2T1}
                  , #{sOc2V2}
                  , #{sOc2T2}
                  , #{sIgo1V}
                  , #{sIgo1T}
                  , #{sIgo2V}
                  , #{sIgo2T}
                  , #{sIgr1V}
                  , #{sIgr1T}
                  , #{sIgr2V}
                  , #{sIgr2T}
                  , #{sSec}
                  , 'A'
                  , #{channel}
    </insert>
</mapper>
