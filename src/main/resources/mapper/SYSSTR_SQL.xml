<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.fscom.firsens.sys.repository.SYSStrRepo">

    <select id="CNT_SYS_STR" parameterType="SYSStrDomain" resultType="int">
        SELECT
            COUNT(*)
        FROM
            F_STORE FS
                LEFT OUTER JOIN F_MEMBER FM ON FM.USERID = FS.USERID
        WHERE
            1 = 1
            <if test="!@org.thymeleaf.util.StringUtils@isEmptyOrWhitespace(areaCode)">AND FS.AREACODE = #{areaCode}</if>
            <if test="!@org.thymeleaf.util.StringUtils@isEmptyOrWhitespace(searchWrd)">
            AND (FS.STRNAME LIKE CONCAT('%', #{searchWrd}, '%')
                 OR FS.STRCODE LIKE CONCAT('%', #{searchWrd}, '%')
                 OR FM.MEMNAME LIKE CONCAT('%', #{searchWrd}, '%'))
            </if>
            AND FS.USEYN = #{useYn}
    </select>

    <select id="LIST_SYS_STR" parameterType="SYSStrDomain" resultType="SYSStrDomain">
        SELECT
            Z.*
        FROM
            (SELECT
                 @ROWNUM := @ROWNUM + 1 AS rownum
                      , A.*
             FROM
                 (SELECT
                      FS.STRCODE AS strCode
                      , FS.STRNAME AS strName
                      , FS.STRADDR AS strAddr
                      , FS.STRORDER AS strOrder
                      , FM.MEMNAME AS strOwnName
                      , FS.STRTEL AS strTel
                      , FS.STROWNTEL AS strOwnTel
                      , FG.GRPCODE AS grpCode
                      , FG.GRPNAME AS grpName
                      , FS.AREACODE AS areaCode
                      , FA.AREANAME AS areaName
                      , FS.LEVELAREACODE AS levelAreaCode
                      , FS.USEYN AS useYn
                      , DATE(FS.REGDATE) AS regDate
                      , FS.STRCODE AS strCodeKey
                  FROM
                      F_STORE FS
                          LEFT OUTER JOIN F_AREA FA ON FS.AREACODE = FA.AREACODE
                          LEFT OUTER JOIN F_GROUP FG ON FS.GRPCODE = FG.GRPCODE
                          LEFT OUTER JOIN F_MEMBER FM ON FM.USERID = FS.USERID
                  WHERE
                      1 = 1
                      <if test="!@org.thymeleaf.util.StringUtils@isEmptyOrWhitespace(areaCode)">AND FS.AREACODE = #{areaCode}</if>
                      <if test="!@org.thymeleaf.util.StringUtils@isEmptyOrWhitespace(searchWrd)">
                      AND (FS.STRNAME LIKE CONCAT('%', #{searchWrd}, '%')
                           OR FS.STRCODE LIKE CONCAT('%', #{searchWrd}, '%')
                           OR FM.MEMNAME LIKE CONCAT('%', #{searchWrd}, '%'))
                      </if>
                      AND FS.USEYN = #{useYn}
                 ) A
                 ,
                 (SELECT @ROWNUM := 0) R
             ORDER BY
                 rownum DESC
            ) Z
        LIMIT
            #{page}, #{sizePerPage}
    </select>

    <select id="CHK_SYS_STRCODE" parameterType="SYSStrDomain" resultType="int">
        SELECT
            COUNT(STRCODE) AS cnt
        FROM
            F_STORE
        WHERE
            STRCODE = #{modifyStrCode}
            AND AREACODE = #{areaCode}
            AND LEVELAREACODE = #{levelAreaCode}
    </select>

    <update id="GENERATE_STORE_CODE" parameterType="SYSStrDomain">
        <selectKey keyProperty="generateKey" resultType="int" order="AFTER">
            SELECT NEXT_ID AS generateKey FROM COMTECOPSEQ WHERE TABLE_NAME = #{keyFied}
        </selectKey>
        UPDATE COMTECOPSEQ SET NEXT_ID = NEXT_ID + 1 WHERE TABLE_NAME = #{keyFied}
    </update>

    <insert id="INSERT_SYS_STR" parameterType="SYSStrDomain">
        INSERT INTO F_STORE (
               STRCODE
             , STRNAME
             , STRADDR
             , STRORDER
             , STRTEL
             , STROWNTEL
             , STRPOSLAT
             , STRPOSLON
             , REGDATE
             , USEYN
             , AREACODE
             , LEVELAREACODE
        ) values (
               CONCAT('FS_STR_', LPAD(#{generateKey} ,'13','0'))
             , #{strName}
             , #{strAddr}
             , #{strOrder}
             , #{strTel}
             , #{strOwnTel}
             , #{strPosLat}
             , #{strPosLon}
             , NOW()
             , #{useYn}
             , #{areaCode}
             , #{levelAreaCode}
        )
    </insert>

    <select id="SELECT_SYS_ONE_STR" parameterType="SYSStrDomain" resultType="SYSStrDomain">
        SELECT
            FS.STRCODE AS strCode
            , FS.STRNAME AS strName
            , FS.STRADDR AS strAddr
            , FS.STRORDER AS strOrder
            , FM.MEMNAME AS strOwnName
            , FS.STRTEL AS strTel
            , FS.STROWNTEL AS strOwnTel
            , FS.STRPOSLAT AS strPosLat
            , FS.STRPOSLON AS strPosLon
            , FG.GRPCODE AS grpCode
            , FG.GRPNAME AS grpName
            , FS.AREACODE AS areaCode
            , FS.LEVELAREACODE AS levelAreaCode
            , FS.USEYN AS useYn
            , FS.DELYN AS delYn
        FROM
            F_STORE FS
                LEFT OUTER JOIN F_GROUP FG ON FS.GRPCODE = FG.GRPCODE
                LEFT OUTER JOIN F_MEMBER FM ON FM.USERID = FS.USERID
        WHERE
            FS.STRCODE = #{strCode}
            AND FS.AREACODE = #{areaCode}
            AND FS.LEVELAREACODE = #{levelAreaCode}
    </select>

    <update id="UPDATE_SYS_STR" parameterType="SYSStrDomain">
        UPDATE
            F_STORE
        SET
            STRNAME = #{strName}
            , STRADDR = #{strAddr}
            , STRTEL = #{strTel}
            , STROWNTEL = #{strOwnTel}
            , STRPOSLAT = #{strPosLat}
            , STRPOSLON = #{strPosLon}
            , USEYN = #{useYn}
            , AREACODE = #{areaCode}
            , LEVELAREACODE = #{levelAreaCode}
        WHERE
            STRCODE = #{strCode}
            AND AREACODE = #{areaCode}
            AND LEVELAREACODE = #{levelAreaCode}
    </update>

    <delete id="DELETE_SYS_STR" parameterType="SYSStrDomain">
        DELETE FROM
            F_STORE
        WHERE
            STRCODE = #{strCode}
            AND AREACODE = #{areaCode}
            AND LEVELAREACODE = #{levelAreaCode}
    </delete>

</mapper>
